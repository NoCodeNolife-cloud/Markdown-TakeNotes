[toc]

# 体系结构

## 计算机网络的概念
### 互联的、自治的计算机系统集合
- 广义观点
- 资源共享观点
- 用户透明性观点

### 最早出现的计算机网络

- ARPAnet
    - 采用**分组交换方式**

## 计算机网络的发展

- ARPANET向互联网发展
- 三级结构互联网
- 多层次ISP结构互联网 
## 计算机网络与分布式计算机系统的主要区别
- 分布式系统
    - 整个系统中的各个计算机对用户都是透明的
- 计算机网络
    - 用户必须登录欲运行的计算机，按照计算机的地址，将程序通过计算机网络传送到该计算机上运行，最后根据用户的命令将结果传送到指定的计算机
- 分布式系统与计算机网络的**主要区别不在于它们的物理结构,而是在于高层软件上**
## 客户、服务器与用户
* 客户与服务器是软件
* 用户是指“人”
## 计算机网络的组成
### 组成部分
- 硬件
- 软件
- 协议
### 工作方式
- 边缘部分
	- C/S方式
	- P2P方式
- 核心部分
	- 网络
	- 路由器
### 功能组成
- 通信子网
	- 传输介质
	- 通信设备
	- 网络协议
- 资源子网
	- 共享设备
	- 软件
## 计算机网络的功能
- 和通信网络相比，计算机网络最本质的特征是**资源共享**
### 数据通信
### 资源共享
- **最基本的特征**
- 软件共享
- 数据共享
- 硬件共享
### 分布式处理
### 提高可靠性
### 负载均衡
### 计算机网络最基本的功能
- 流量控制
- 分布式处理
- 传输控制
## 计算网络分类
### 分布范围
- 广域网
	- WAN
		- 点对点技术
- 城域网
	- MAN
- 局域网
	- LAN
		- 广播技术
- 个人区域网
	- PAN
### 传输技术
- 广播式网络
	- 局域网
- 点对点网络
	- 广域网
### 拓扑结构
- 总线形
- 星形
	- n个结点，n-1个物理链路
- 环形
- 网状形
### 使用者
- 共用网
- 专用网

### 因特网服务提供者的英文简称

- ISP
### 交换技术
- 电路交换网络
	- 优点
		- 数据直接传输
		- 时延最小
	- 缺点
		- 线路利用率低
		- 不能充分利用线路容量
		- 不便差错控制
- 报文交换网络
	- 优点
		- 充分利用线路容量
		- 实现不同链路之间不同数据率的转换
		- 实现差错控制
	- 缺点
		- 增加缓冲时延
		- 增大资源开销
- 分组交换网络
	- 优点
		- 充分利用线路容量
		- 实现不同链路之间不同数据率的转换
		- 实现差错控制
		- 缓冲易于管理
		- 平均时延更小
		- 平均缓冲区更小
		- 易于标准化
### 传输介质
- 双绞线
- 同轴电缆
- 光纤
- 无线传输介质
## 计算机网络标准化
- 四个阶段
    - **因特网草案**
        - 这个阶段还不是RFC文档
    - **建议标准**
        - 从这个阶段开始就成为RFC文档
    - **草案标准**
    - **因特网标准**
### 法定标准
- ISO/OSI
### 事实标准
- TCP/IP

## 计算机网络性能指标

### 带宽
- 网络通信线路传送数据的能力,指的是**最高数据率**
- 赫兹（Hz）
	- 比特/秒(bit/s)

### 时延

- **发送时延(传输时延)**
  
    - 主机或路由器发送数据帧所需要的时间
    $$
    发送时延=\frac{数据帧长度}{发送速率}
    $$
- **传播时延**
  
    - 电磁波在信道中传播一定的距离所需要花费的时间
    $$
    传播时延=\frac{信道长度}{电磁波在信道上的传播速率}
    $$
    - RTT为两倍传播时延
    
- 处理时延
- 排队时延
$$
总时延=发送时延+传播时延+处理时延+排队时延
$$
### 时延带宽积
- 以比特为单位的链路长度
$$
时延带宽积=传播时延\times带宽
$$
- 以比特为单位的链路长度
	- 某段链路现在有多少比特
### 往返时延RTT
- 传播时延*2
### 吞吐量
- 单位时间内通过某个网络的数据量,每秒能发送的数据量
	- 受网络的带宽或网络的额定速率的限制
	$$
	Tp=\frac{L}{\frac{L}{C}+RTT}
	$$
### 速率
- 在数字信道中传送数据的速率

- 比特/秒
     $$
     R_b=R_B\times \log_2N
     $$
### 信道利用率
- 有数据通过时间/（有数据通过时间+无数据通过时间）
$$
E=\frac{\frac{L}{C}}{\frac{L}{C}+RTT}
$$
## 计算机网络分层结构
- 分层和协议的集合称为计算机网络的**体系结构**
- 两个对层层交换数据的大小叫做**PDU**
### 分层原则
- 层类功能内聚
- 层间耦合松散
### 分层目标
- 便于从理论上对计算机网络进行描述和分析（主要原因）
- 实现相对独立的功能，降低系统复杂度
- 各层相互交流尽可能小
- 各层功能精确定义独立于具体的实现方法，采用最合适的技术来实现
- 保持下层对上层的独立性，上层单向使用下层提供的服务
- 整个分层结构能促进标准化的工作
### 层次结构含义
- 第n层的实体要使用第n-1层的服务实现自身定义功能，还要向n+1层提供本层服务
- 最底层只提供服务
- 最高层面向用户提供服务
- 上一层只能通过相邻层间接口使用下一层的服务，而不能调用其他层的服务
## 计算机网络协议、接口、服务概念
### 接口
- 同一结点内相邻两层间交换信息的连接点

- 同一结点相邻两层的实体由服务访问点（SAP）进行交互

- 每个SAP都有一个能标识接口的地址

     |            |         |
     | :--------: | :-----: |
     | 数据链路层 | MAC地址 |
     |   网络层   | IP地址  |
     |   传输层   |  端口   |
### 协议
- 协议就是规则的集合
- 水平
- 三要素
    - **语法**
	    - 规定传输数据的格式
    - **语义**
	    - 规定所要完成的功能
    - **同步**
	    - 规定各种操作的顺序
- 完整的协议
	- 线路管理
	- 差错控制
	- 数据交换
- 对低层采用的协议，**对高层而言是透明的**
### 服务(SAP)
- **下层**为紧邻的**上层**提供的功能调用
- 垂直
- 服务原语
	- 请求
		- 服务用户发往服务提供者
	- 指示
		- 服务提供者发往服务用户
	- 响应
		- 服务用户发往服务提供者
	- 证实
		- 服务提供者发往服务用户
- 类型
	- 有应答服务
	- 无应答服务
- 面向连接和连接服务
     - 有连接是建立在确认的基础上的
     - 不存在无确认面向连接的服务
## SCI+PDU=SDU
- **SCI服务控制信息**
- **PDU协议数据单元**
- **SDU服务数据单元**

## ISO/OSI参考模型

### 应用层
- 为特定类型的网络应用提供访问OSI环境的手段，提供用户和网络的接口
- 所有能和用户交互产生网络流量的程序
- 服务访问点：用户界面
- 服务
  - 域名系统
    - DNS
      - 迭代(星形)
      - 递归(总线型)
  - 文件传输
    - FTP
         - 服务器端口
              - 21控制端口
              - 20数据发送端口
  - 电子邮件
    - SMTP(发)
    - POP3(收)
    - HTTP(基于网站)
  - 万维网
    - HTTP
         - WWW
         - URL
### 表示层
- 处理在两个通信系统中交换信息的表示方式，表示为用户能够看得懂的形式
	- 抽象标准方法定义数据结构
	- 采用标准的编码方式
	- 压缩和恢复
	- 加密
	- 格式转换
### 会话层
- 不同主机上的各个进程之间进行会话
	- 会话管理
		- 建立、管理和终止应用程序之间的会话
	- 同步
		- 建立同步SYN
	- 有序
	- 建立连接
	- 恢复通信，实现数据同步
### 传输层
- 单位：报文段（TCP）和用户数据报（UDP）

- 功能
	- 流量控制
	- 可靠传输、不可靠传输
	- 差错控制
	- 复用分用
	- 服务质量、数据传输管理
	
- 建立

- 维护

- 拆除

- 第一个提供**主机之间端到端服务**

- **进程**之间的逻辑通信

- 服务访问点：端口号

- socket
     $$
     socket=[主机端口地址,端口号]
     $$
     
- 协议
	- TCP
		- 有连接传输
			- 可靠传输
	- UDP
		- 无连接传输
			- 不可靠传输
    - ARQ流量控制协议
  
- **面向连接**
### 网络层
- 单位：数据报分组
	- 把网络层的协议数据单元（分组）从源端传到目的地，控制报文通过网络的路由选择
- 功能
	- 流量控制
	- 拥塞控制
	- 差错控制
	- 路由选择
- 服务访问点：IP地址
- 设备
	- 路由器
		- 既隔离广播域,也隔离冲突域
- 协议
	- IP
	- IPX
	- ICMP
        - 控制报文协议
	- IGMP
	    - 组播协议
	- ARP
	    - 地址转换协议
	    - 用IP查询MAC地址
  - RARP
	      - 反向地址转换协议
            - 用MAC地址查询IP地址
  - OSPF
        - 链路状态路由协议
            - 洪泛法
            - 区域
- **面向连接**
- **无连接**
     - IP数据报

### 数据链路层

- 单位：帧
	- 将网络层传来的IP数据报组装成帧，确保数据正确的顺序和完整性
- 功能
	- 成帧
	- 差错控制
	- 流量控制
	- 传输管理
- 服务访问点：MAC地址
	- 物理地址(MAC)
	- Media Access  Protocol
- 设备
	- 交换机，网桥
		- 隔离冲突域
		- 不隔离广播域
- 协议
	- HDLC
	- PPP
### 物理层
- 单位：比特
	- 在物理媒体上为数据端设备透明地传输原始比特流的**逻辑连接**，处理信号通过介质的传输
- 功能
	- 定义接口特性
	- 定义传输模式
		- 单工
		- 半双工
		- 双工
	- 定义传输速率
	- 比特同步
	- 比特编码
- 服务访问点：网卡接口
- 设备
  - 集线器，中继器
       - 既不隔离冲突域,也不隔离广播域

## TCP/IP模型

* 类型不同的网路使用TCP/IP协议都可以互联成网
* 将应用层/表示层/会话层统称为应用层

### 应用层

- 虚拟终端协议
	- Telnet
- 文件传输协议
	- FTP
- 域名解析服务
	- DNS
- 电子邮件协议
	- SMTP
- 超文本传输协议
	- HTTP
### 传输层（TCP）
- 传输控制协议
	- 面向连接
		- 单位：报文段
- 用户数据报协议
	- 无连接
		- 单位：用户数据报
* 传输层处理关于**可靠性、流量控制和错误校正**等问题
- **面向连接**
- **无连接**
### 网际层（IP）
- 关键部分
	- **无连接**
### 网络接口层
- MAC子层
- LLC子层
## TCP/IP协议与ISO/OSI协议的区别

|         TCP/IP         |        ISO/OSI         |
| :--------------------: | :--------------------: |
|      网络层无连接      | 网络层面向连接与无连接 |
| 传输层面向连接与无连接 |      传输层有连接      |

# 物理层
## 通信基础
- 计算机通信系统是**数据通信系统**
- 误码率表征通信系统的**可靠性**
- 传输速率表征通信系统的**有效性**
### 通信系统三要素
- 信源
- 通信媒体
- 信宿
### 数据
- 传送信息的实体
### 信号
- 数据的电气或电磁表现，是在数据传输过程中的存在形式
### 码元
- 用一个固定时长的信号波形（数字脉冲）表示一位k进制数字

- 不同离散数字的基本波形

- 数字通信中数字信号的计量单位

- 一个码元可以携带多个比特的信息量
     $$
     R_b=R_B\times \log_2N
     $$

### 数据传输方式

- 串行传输
	- 一个一个的比特传输
- 并行传输
	- 多个比特同时传输
		- 计算机内部数据传输
### 数据通信系统
- 信源
	- 产生和发送数据的源头
- 信道
	- 信号传输的媒介
		- 双向包含两个信道
			- 发送信道
			- 接收信道
- 信宿
	- 接收数据的终点
### 传输信号的形式
- 模拟信号
     - 频带传输
- 数字信号
     - 基带传输
### 信道上传输的信号
- 基带传输
	- 不经过调制就在信道上直接进行传输
	- **数字信道**
- 频带传输
	- 用数字信号对特定频率下的载波进行调制，将其变成适合于传送的信号后再进行传输
- 宽带传输
	- 将链路容量分成两个或多个信道，每个信道可以携带不同的信号 
	- **模拟信道**
### 交互方式
- **单工通信**
	- 只有一个方向的通信
	- 一条信道
- **半双工通信**
	- 双方都可以发送或接收信息，但是不能同时传输和接收信号
	- 两条信道
- **双工通信**
	- 通信双方可以同时发送和接收信息
	- 两条信道

### 通信

- 计算机网络通信采用同步和异步两种方式，但传送效率最高的是**同步**
- 同步
	- **帧定界符**
	- 全网同步
	- 准同步
	- 发送**帧**
- 异步
	- **开始码与停止码**
	- 发送**字节**
### 速率
$$
R_b=R_B\times log_2N
$$
- 码元传输速率$R_B$
	- **单位时间内数字通信系统所传输的码元个数**
		- 单位：波特(Baud)
	- 码元速率与进制数无关
	- **表示信号每秒变化的次数**
	
- 信息/数据传输速率$R_b$
	- 单位时间内数字通信系统传输的**二进制码元**的速率(即比特数)
    - 单位:比特/秒(bit/s或bps)
    - **在进制数等于2时,$R_b=R_B$**
- 带宽
	- 单位时间内从网络中的某一点到另一点所能传输数据的能力
	- 带宽是传输数据的度量
- **T1系统的传输速率为1.544Mbps，有效速率为1.344Mb/s；E1系统的数据传输速率为2.048Mbps，有效速率为1.92Mb/s**
### 两个定理
- 码间串扰
	
	- 接收端收到的信号波形失去了码元之间清晰界限
- 奎奈斯特定理(理想)
	
	- 理想低通的信道中，极限码元传输率为2W波特
		- 码元传输速率是受限的
		- 采样频率大于或等于有效信号的最高频率或其带宽的2倍
  	- 单位：bit/s
    $$
    C_{max}=f_{采样}\times log_2N=2f\times log_2N
	  $$
	- 结论
		- 在任何信道中，码元的传输速率是有上限的
			- 码间串扰
		- 信道的频带越宽，就可以用更高的速率进行码元的有效传输
- 香农定理(有噪声)
    $$
	C_{max}=W\times log_2(1+\frac{S}{N})
	$$
	- 信噪比
		- 分贝形式
			
			- dB
			     $$
			     \frac{S}{N}={10}^\frac{DB}{10}
			     $$
	- 信道的带宽或信道中的信噪比越大，信息的极限传输速率越高
	- 结论
		- 一定的传输带宽和一定的信噪比，信息传输速率的上限是确定的
			- 信道带宽
			- 信噪比
		- 实际信道能达到的传输速率要比极限信息传输速率低
		- 一个码元所对应的二进制数是有限的
### 编码与调制
- 编码
	- 把数据变换为数字信号
		- 归零编码(RZ)
			- 高电平代表1
			- 低电平代表0
			- 每个时钟周期的中间均跳变到低电平
		- 非归零编码(NRZ)
			- 不用归零
			- 不包含同步信号
		- 反向非归零编码(NRZI)
			- 信号的翻转代表0
			- 信号保持不变代表1
		- 曼彻斯顿编码
			- 以太网使用方式
			- 信号
				- 时钟
				- 数据取值
			- 图像
				- 前一个间隔为高电平而后一个间隔为低电平表示码元1
				- 前一个间隔为低电平而后一个间隔为高电平表示码元0
			- 包含同步信息
			- **2个Baud对应1个bit的信息**
			     - 100BASE-T速率为100Mbit/s,传输200MBaud,传输介质为双绞线
			     - F表示光纤
		- 差分曼彻斯顿编码
			- 局域网传输
			- 作图法
				- **有跳变**代表二进制位0
				- **无跳变**这代表二进制位1
		- 4B/5B编码
			- 编码效率80%
- 调制
	- 数字信号转模拟信号
		- 幅移键控
			- ASK
		- 频移键控
			- FSK
		- 相移键控
			- PSK
		- 正交振幅调制
			- QAM
				- 相移调制
					- m个相位
				- 幅移调制
					- n种振幅
		- 脉冲编码调制
			- 语音信号
- 模拟数据编码为数字信号
    - **应用：调制解调器**
	- PCM
		- 抽样
			- 对模拟信号进行周期性扫描
		- 量化
			- 把采样取得的电平幅值按照一定的分级标准转化为对应的数字值并去整数
		- 编码
			- 把量化的结果转换为与之对应的二进制编码
	- PCM的缺点
		- **速率标准不统一**
		- **不是同步传输**
    - 应用
    
        - 传递语音信号
    
- 频分复用
	- FDM
		- 充分利用带宽资源

### 交换传输方式

- 电路交换
	- 进行数据交换之前，两个结点之间必须建立一条专用的物理通信路径，改路径可能经过多个中间结点
		- 连接建立
			- 数据传输
				- 连接释放
	- 优点
		- 通信时延小
		- 有序传输
		- 没有冲突
		- 适用范围广
		- 实时性强
		- 控制简单
		- 传输时延**最小**
	- 缺点
		- 建立连接时间长
		- 线路独占，使用效率低
		- 灵活性差
		- 难以规格化
		- 不具备差错控制的能力
			- 无法纠正传输过程中产生的数据差错
	- 实时性最好，信息延时短，且固定不变
	- 应用
    	- **市话网**
- 报文交换(**储存转发**)
	- 数据交换的单位：报文
		- 携带
			- 目标地址
			- 源地址
	- 特点
		- PDU长度不是固定的
	- 优点
		- 无需建立连接
		- 动态分配线路
		- 提高线路利用率
		- 提供多目标服务
	- 缺点
		- 引起转发时延
		- 要求网络结点需要有较大的缓存空间
	- 计算
		- 报文发送时延
		- 传播时延
		- 1Byte=8bit
- 分组交换(**分组转发**)
	- 数据交换的单位：分组
	- 分组交换
		- 分组转发方式
			- 把大的数据块划分为合理的小数据块，再加上一些必要的控制信息，构成分组
				- 网络节点根据控制信息把分组送到下一个结点，下一结点接收到分组后，暂时保存并排队等待传输，然后根据分组控制信息选择它的下一个结点，知道到达目的地
		- 特点
			- PDU<u>***长度较短且固定***</u>
		- 优点
			- 无建立时延
			- 无需建立连接
			- 线路利用率高
			- 储存转发，动态分配线路
			- 线路可靠性较高
			- 简化了储存管理
		- 缺点
			- 存在传输时延
			- 需要传输额外的信息量
				- 降低通信效率，增加了处理的时间，是控制复杂，时延增加
			- 可能会出现失序、丢失或重复分组
			- 有最大长度的限制
		- 计算
			- 分组发送时延
			- 传播时延
			- 时间
				- 第一个分组刚开始发送到最后一个分组接收完毕
					- 把整个分组发送到链路的时间
					- 最后一个分组经历几个交换设备的时间
			- 1Byte=8bit
	- 数据报与虚电路
		- 数据报
			- 作为通信子网用户的端系统发送一个报文时，在端系统中实现的高层协议先把报文拆成若干带有序号的数据单元，并在网络层加上地址等控制信息后形成数据报分组（PDU）
				- 中间结点储存分组很短一段时间，找到追加的路由后，尽快转发每个分组
			- 特点
				- 发送分组之前**不需要建立连接**
				- 网络尽最大努力交付，不保证可靠性，可能丢失
					- **不保证按序到达**
					- **不保证可靠性**
				- 发送的分组中要包括发送端和接收端的完整地址
					- 源地址
					- 目标地址
				- 分组在交换结点存储转发时，要排队等候处理
				- 网络具有冗余性
				- 储存转发延时较小，提高网络的吞吐量
				- 收发双方不独占某一链路
				- 网络为每个分组独立地选择路由，传输不保证可靠性，也不保证分组的按序到达
				- 储存转发技术
		- 虚电路
			- 分组发送之前，要求在发送方和接收方建立一条逻辑上相连的虚电路，并且连接一旦建立，就固定了虚电路所对应的物理路径
				- 连接建立
					- 数据传输
						- 连接拆除
				- 路由选择体现在连接建立阶段，连接建立后，就确定了传输路径
			- 特点
				- 面向连接
					- 有连接
				- 通信链路的建立和拆除需要时间开销
					- 小量
						- 浪费
					- 长时间、频繁
						- 效率较高
				- 分组首部并不包含目的地址，而包含虚电路标志符
					- 不包含目的地址
				- 虚电路“虚”，是因为这条电路不是专用的，每个结点到其他结点之间可能同时有若干个虚电路通过，<u>*可能同时与多个结点之间建立虚电路*</u>
				- 属于同一虚电路的分组按照同一路由转发
					- 可靠，能保证每个分组正确有序到达
						- **正确**
						- **有序**
					- 致命弱点
						- 网络中某个结点或链路出现故障而彻底失效，所有经过该结点或链路的虚电路将遭到破坏
## 传输介质
### 有线传输介质
- 双绞线(T)
  - 一定规则并排耦合的、相互绝缘的铜导线组成
  - **局域网中成本最低、最常用的是双绞线**  
  - 价格便宜
  - 传送数字信号
  - 最常用传输介质之一
  - 分类
  - - **屏蔽双绞线**
    - *非屏蔽双绞线*
    - 绞合
    
  - 减少电磁干扰
    
    - 屏蔽双绞线
    
        - 双绞线外再加上一层用金属丝编制成的屏蔽层
    
    - 10BASE-T使用双绞线作为传输介质，最大网段长度为**100M**
- 同轴电缆
    - 传输模拟信号
	- 内导体、绝缘层、网状编织屏蔽层和塑料外层构成
		- 更高的屏蔽性
		     - 同轴电缆比双绞线传输速度更快,得益于屏蔽性
		- 更好的抗噪声性
	- 50Ω同轴电缆主要用于传输**基带数字信号**
		- 基带同轴电缆
			- 应用于局域网
	- 75Ω同轴电缆主要用于传送宽带信号
		- 宽带同轴电缆
			- 应用于有线电视系统
	- 同轴电缆互联主机构成以太网，主机间通信方式为半双工
	- **粗同轴电缆**支持最大的电缆长度
- 光纤(F)
	- 光导纤维传递光脉冲进行通信
		- 有光脉冲表示1
		- 无光脉冲表示0
	- 多模光纤
		- 近距离传输
		- 发光二极管
	- 单模光纤
		- 远距离传输
		- 激光
	- 纤芯实心
	- 特点
		- 损耗小
		- 典型传输速率最高
		- **抗电磁干扰性最好**
		- 不易窃听，泄露数据
		- 误码率最低
		- 不受电磁干扰或噪声影响
		- **费用大**

缩写 | 含义
---|---
10Base5 | 数据传输率10Mbis/s，BASE表示基带信号，最大跨度500m
10Base2 | 数据传输率10Mbis/s，BASE表示基带信号，最大跨度200m
10BaseT | 数据传输率10Mbis/s，BASE表示基带信号，使用双绞线传输介质
1Base5 | 数据传输率1Mbis/s，BASE表示基带信号，最大跨度500m
10BROAD36 | 数据传输率10Mbis/s，BROAD表示宽带信号，最大跨度3600m
100BASE-T标准规定网卡与HUB之间的非屏蔽双绞线长度最大为**100M**

​	T表示双绞线

​	F表示光纤

### 无线传输介质
- 无线电波
	- 所有方向传播
	- 有效距离内接收设备无须对准某个方向，就可与无线电波发送者进行通信连接
- 微波、红外线、激光
	- 直线传播
## 物理接口层的特性
### 机械特性
- 物理连接的定义点
### 电气特性
- 电压高低、阻抗匹配、传输速率和距离限制
### 功能特性
- 指明某条线上出现的某一电平的电压表示何种意义，接口部件的信号线的用途
### 规程特性
- 各条物理线路的工作规程和时序关系
## 物理层设备
### 中继器/转发器
- 放大器
    - 放大模拟信号
- 将信号整形并放大转发出去
	- 再生数字信号
		- 信号再生，而不是放大
- 转发器
    - 只具有**放大信号**的功能
- 两个端口
	- 数据输入
	- 数据输出
- 扩大网络规模
- 5-4-3原则
	- 五段通信介质
	- 四个中继器
	- 三段挂接计算机
### 集线器/多口中继器
- 再生放大信号
- 网络中只起信号放大和转发作用
	- 共享式设备
- 不具备信号的定向传送能力
- 同属于一个冲突域，同属于一个广播域
- **接收信号之后，从除输入端口以外的所有端口转发出去**
- 星形
- 两个网段在物理层进行互联，要求数据传输率相同，物理层以上协议可以不同
- 模拟信道为放大器
- 数字信道为中继器
- 快速以太网集线器按结构分为**共享型和交换型**
# 数据链路层
​	<u>*MTU指的是数据链路层的最大数据单元*</u>

​	<u>***MTU=1500B***</u>

## 功能

### 为网络层提供服务
- **实现有效、可靠数据传输，对传输操作进行严格的控制和管理**
- 对网络层表现为无差错的链路
- **无确认的无连接服务**
	- 以太网
- **有确认的无连接服务**
	- 无线通信
- **有确认的面向连接服务**
	- 帧传输的阶段
		- 建立数据链路
		- 传输帧
		- 释放数据链路
- 面向连接是由确认保证的,<u>***不存在无确认的面向连接服务***</u>
- 数据链路层不必考虑物理层如何实现比特传输的细节
- 链路管理
- 帧定界
- 帧同步
    - **从收到的比特流中正确无误地判断出哪一个帧从哪一个比特开始到哪一个比特结束**
- 透明传输
    - **不管所传输的数据是什么样的比特组合，都应当在链路上进行传送**
- 流量控制
- 差错控制
- 组帧
### 帧
- 数据链路层以太网传送,要增加**18B的长度**
- 帧
    $$
    首部+数据+尾部
    $$
	- 数据的前后分别添加**首部**和**尾部**
		- 控制信息
			- **帧定界**,确定帧的界限
- 帧同步
	
	- 接收方能从接收到的二进制比特流中区分出帧的起始与终止
- 透明传输
	- 不管传输数据是怎样的组合，都能在链路上进行传送
	- 某一个实际存在的事物看起来却好像不存在一样
        - 添加转义字符"ESC"
            - **字节填充或字符填充**
    
    - 方法
    
        - 字符计数法
        - 字符填充法
        
            - PPP
        
        - 零比特填充法
        
            - HDLC
- 控制
	- 流量控制
		- 限制发送方的数据流量，发送速率不会超过接收方的接收能力
	- 差错控制
	    - 为防止传输过程中的帧的丢失，数据链路层采用的方法是**计时器超时重发**
		- 位错
			- 发现位错
				- 循环冗余校验
			- 重传
				- 自动重传请求
		- 帧错
			- 引入定时器和编号机制
### 目的
- 使接收方能正确接收并检查所传输的帧
- 依据一定的规则把网络层递交的分组封装成帧
### 解决
- 帧定界
- 帧同步
	- 区分帧的起始与终止
- 透明传输
### 方法
- **字符计数法**
	- 帧头部用计数字段标明帧内字符数
	- 1Byte=8bit
	- 计数字段出错，接收方无法判断传输帧的结束位和下一帧的开始位
	- 字符计数法**包括计数符其本身**，例如要发送n个信息，记为n+1
- **字符填充的首尾界符法**
	- 开始(DLE STX)
	- 结束(DLE ETX)
	- 转义字符
		- 当传输数据的恰好是控制字符
		- 恢复数据要把转义字符删除
- **零比特填充的首尾标志法**
	- 允许数据帧包含任意个数的比特，允许每个字符的编码包含任意个数的比特
	- 容易由硬件实现
	- HDLC使用的方法
	- 发送端
		- 信息位遇到连续的**5个“1”**时，自动在其后插入1个“0”
	- 接收端
		- 信息位遇到连续的**5个“1”**时，自动在其后删除1个“0”
- 违规编码法
	- 曼彻斯特编码
	- 物理层进行比特编码
	- 不需要采用任何填充技术
	- 只适用于采用冗余编码的特殊环境
## 差错控制
### 全局性
- 随机噪声
	- 提高信噪比
### 位错
- 数据传输中产生差错的主要原因是**冲击噪声**
- 比特差错
	- 检错编码
		- 奇偶校验码
			- 奇校验
				- 传输的数据中”1“的个数是偶数个则可以检测出错误
			- 偶校验
				- 传输的数据中”1“的个数是奇数个则可以检测出错误
			- 只能检查出奇数个比特错误，检错能力50%
			- 组成
				- n-1信息元
				- 1校验码
		- **循环冗余码(CRC)/多项式码**
            - 带r个校验位的多项式编码可以检测到所有长度**小于或等于r**的突发性错误
                - 通信双方必须商定使用多项式编码
                - 在数据链路层使用CRC，能够实现无比特差错的传输，但这不是可靠的传输
			
        - 步骤
			        - 发送端
				        - 要发送数据末端加0
					    - 假设生成多项式G(x)的阶为r，则加r个0
					    - 多项式位数为n，加n-1个0
				        - 模2除
					    - 余数
						    - 帧检验序列(FCS)
						    - **添加几位零,就有几位FCS**,这在最终计算发送数据时特别注意**不够位数要补足**
				        - 发送的数据为
				
				$$
				数据+FCS(数据模二除余数)
				$$
				
				- 接收端
				    - 把收到的每一个帧都**除以相同的除数P**(模二运算),然后检查得到的余数R(不用加零)
				    - 无差错,**余数R肯定为0**
				- 发送端帧检验序列FCS的生成和接收端的CRC检验都是用**硬件**来完成的
				- 在数据链路层中使用CRC检验,能够实现无比特差错的传输,**但还不是可靠传输**
	- 纠错编码
		- 海明码
  		- 确定海明码位数
  			- n为有效信息位数，k为校验位位数，信息位n和校验位k应满足
	          $$
	          2^k-1 \geq k+n
	          $$
			  
			- 确定校验位分布
			
			- 分组以形成校验关系
			
			- 校验位取值
			
			- 发现双比特错，纠正单比特错
			
			- 海明码可以纠正一位差错
			
			- <u>***检错d位,需要码距为d+1的编码方案***</u>
			
			- <u>***纠错d位,需要码距为2d+1的编码方案***</u>
## 计算公式
$$
U=\frac{发送窗口最大值\times 发送一数据帧的时间}{发送一数据帧的时间+往返时间+发送一确认帧的时间}=\frac{N\times T_d}{T_d+RTT+T_a},稍待确认T_a=T_d
$$

## 介质访问技术(MAC)

- 为使用介质的每个结点隔离来自同一信道上其他结点所传送的信号，以协调活动结点的传输

### 介质访问控制（MAC）子层

### 链路种类
- 点对点链路
	- 广域网
- 广播式链路
	- 局域网
### 介质访问控制协议
#### 静态划分

- 信道划分介质访问传输
  - 多路复用技术
    - **多个信号组合在一条物理信道上进行传输，使多个计算机或终端设备共享信道资源**
      - 频分多路复用（FDM）
      	- 充分利用了传输介质的带宽，系统效率较高
      	- 技术成熟，实现比较容易
      	- 适合传输模拟信号
      	- **介质的可用带宽超过要传信号的带宽，所有用户在同样的时间占用不同的带宽资源**
      	
      - 时分多路复用（TDM）

           - **所有用户在不同的时间占用同样的频带宽度**
           - 统计时分复用
             - STDM帧
             - 输入缓存区
             - **按需动态分配时隙**
             	- 同步时分多路复用
             	- 异步时分多路复用
             - 共享带宽，分时利用信道
           - 适合传输数字信号
           - 介质的位速率大于单个信号的位速率
           - 信元交换是一种使用**异步时分多路复用技术**的交换技术

      - 波分多路复用（WDM）
      	
      	- 光信号
      	
      - 码分多路复用（CDM）
      	- 频谱类似于白噪声
      	- 采用不同的编码来区分各路原始信号
      		- **规格化内积**
      		    $$
      		    S\cdot T=\frac{1}{m}\sum^m_{i=1}S_iT_i
      		    $$
      		    - 结果等于1表示发送1
      		    - 结果等于-1表示发送0
      		    - 结果等于0表示什么也没发送
      		    * A发送给B的数据就由A的码片来规格化内积得出B收到的数据
      	- 码分多址CDMA
      		
      		- 码片

#### 动态划分

- 随机访问介质访问控制(存在冲突)
	- ALOHA协议
		- 纯ALOHA协议
			- 当网络中的任何一个站点需要发送数据时，可以不进行任何检测就发送数据
			- 一段时间内未收到确认，认为发生了冲突
				- 超时等待随机时间再重发
		- 时隙ALOHA协议
			- 把所有各站在时间上同步起来，将时间划分为一段一段等长的时隙
	- CSMA协议
		- 与ALOHA协议相比，多了个载波监听装置
			- 1-坚持CSMA
				- 忙则一直监听
			- 非坚持CSMA
				- 忙不继续监听，等待一段随机时间再监听
			- p-坚持CSMA
				- 时分信道
					- 信道空闲
						- 以概率p发送数据
						- 以概率（1-p）推迟到下一时隙
					- 忙不继续监听，等待一段随机时间再监听
	- CSMA/CD协议(碰撞检测)
		- 总线型网络或**半双工网络**,不可能进行全双工通信
		- **先听后发，边听边发，冲突停发，随机重发**
		- 最短帧长度
			- 信号在最远两个端点之间往返传输的时间内发出的比特数
			$$
			最小帧长=单向传输时延\times 数据传输率\times 2=RTT\times 数据传输率=\frac{传输距离}{传播速度}\times 数据传输率\times 2
			$$
  	- 二进制指数退避算法(拥塞控制算法)
			- **考虑了负载的影响**
			$$
	    从整数[0,2^k-1]中随机选择,k=min[重传次数,10],最多[0,1023]
  		$$
			- **重传16次仍不能成功**,丢弃该帧,向高层报告
		- 争议期/冲突检测时间
	            - **确保发送站点在传输时能检测到可能存在的冲突**
			- **信号在最远两个端点之间往返传输的时间**
				- 2τ
		- 应用
			
			- 有线以太网
	- CSMA/CA协议
		- 信道预约
			- RTS
			- CTS
		- 流程
			- 检测信道是否空闲
			- 空闲发出RTS
				- RTS
					- 请求发送帧
						- 发射端的地址
						- 接收端的地址
						- 下一份数据将持续发送的时间
			- 接收端收到RTS后，相应CTS
				- CTS
					- 清除发送帧
			- 发送端收到CTS后，开始发送数据帧，同时预约信道
			- 接收端收到数据帧后，用CRC来检验数据是否正确，正确则相应ACK帧
			- 发送方收到ACK后，就可以进行下一个数据帧的发送
				- 二进制指数退避算法
		- 应用
			- 无线互联网
- 轮询访问介质访问控制
	- 令牌传递协议(**802.4**)
		- 令牌环局域网
			- 特点
			    - **差分曼彻斯特编码**
				- 计算机都不需要发送数据帧时，令牌就在环形网上游荡，而需要发送数据的计算机只有拿到该令牌后才能发送数据帧，不会发送冲突
				- 无论负载如何，都无冲突发生
				- 占全部带宽
				- 同一时刻，环上只有一个数据在传输
				- 网上所有结点共享网络带宽
				- 星形拓扑结构
				- 重负载下信道利用率高
				- 单向逐站传送
				- 每个结点都可以在一定的时间内获得发送数据的权利，并不是无限制地持有令牌
			- 传递过程
				- 网络空闲时，环路中只有令牌帧在循环传递
				- 令牌传递到有数据要发送的站点处时，该站点就修改令牌的一个标志位，并在令牌中附加自己需要传输的数据，将令牌变为一个数据帧，然后将这个数据帧发送出去
				- 数据帧沿着环路传输，接收到的站点一边转发数据，一边查看帧的目的地址
				- 数据帧沿着环路传输，知道到达该帧的源站点，源站点接收到自己发出去的数据帧后便不再转发
				- 源站点传送完数据后，重新生成一个令牌，并将令牌传递给下一个站点 ，以交出对媒体的访问权限
			- 问题
				- 令牌开销
				- 等待延迟
				- 单点延迟
			- 令牌持有时间
			- **FDDI**使用令牌环介质访问方法

## 局域网
* 局域网接入广域网是通过**路由器**实现的
### *<u>决定局域网特性主要技术</u>*
- <u>*传输媒体*</u>
- <u>*拓扑结构*</u>
- **<u>*媒体访问技术*</u>（决定性）**
### 主要特征
- <u>***为一个单位所拥有，地理范围和站点数目均有限***</u>
- 所有站点共享较高的总带宽
- 较低的时延和较低的误码率
- 各站为平等关系而非主从关系
- 能进行广播和组播
	- **广播技术**
- 无连接的不可靠服务
- 按局域网基本工作原理分类,分为**共享媒体局域网(集线器)**,**交换局域网(交换机)**,**虚拟局域网(三组交换机组成的逻辑电路)**
### 局域网介质访问控制方法
- CSMA/CD
	- 总线型局域网
- 令牌总线
- 令牌环
	- 环行局域网
### OSI层次
- 物理层
- 数据链路层
### 分类
- 以太网
	- 逻辑为总线型结构
	- 物理为星形或拓展星形结构
	- 以**广播形式**发送
	- 硬件地址**48位**
- 令牌网
	- 逻辑为环形结构
	- 物理为星形结构
- FDDI
	- 逻辑为环形结构
	- 物理为双环结构
- ATM网
- 无线局域网
	- 采用IEEE 802.11
### MAC子层
- 数据帧的封装/卸载
- 帧的寻址和识别
- 帧的接收与发送
- 链路的管制
- 帧的差错控制
### LLC子层
- 识别网络层协议
- 为网络层提供服务
- 建立和释放数据链路层的逻辑连接
- **提供与网络层的接口**
- **数据帧编号**
- **差错控制**
### IEEE 802标准
- IEEE 802.3
	- 以太网介质访问控制协议及物理层技术规范
	    - 以太网帧最小数据载荷为**46**字节
	    - 本地网络上的主机通过**MAC地址**查找到其他网络设备
	    - 纠错由高层来决定
		- 介质访问控制MAC地址
		    - 全世界范围**32位唯一标识符**
			- 用于控制主机在网络上的数据通信
			- 数据链路层设备都使用各个网卡的MAC地址
		- CSMA/CD协议
		- 采用**循环冗余码**为校验码
		- 拓扑结构
			- 物理上星形
			- 逻辑上总线型
		- 特点
			- 无连接
			- 不可靠
		- 网卡（NIC）是局域网中连接计算机和传输介质的接口
			- 唯一代码称为介质访问地址MAC地址
				- **MAC地址唯一,若有相同的静态MAC地址，这两个设备都不能正常通信**
				- MAC地址可以通过**ARP**协议查得
			- 网卡实现的主要功能在物理层和数据链路层
				- **物理层**
				- **数据链路层**
			- 网卡功能
                - 数据转换
                    - 通信服务
                    - 数据缓存
		- 规定传输介质的最大长度不能超过**500m**
		- 以太网MAC帧的最小长度为**64B**，凡是小于64B的帧都是**无效帧**
		- 以太网最小长度为64B，其中包括以太网帧头部的地址、类型域以及帧尾部的校验和域，这些部分的长度为**18B**
		- **共享式以太网**采用**集线器**
		- **交换式以太网**采用**交换机**
		- 高速以太网
			- **100BASE-T以太网**
				- T代表**双绞线**
				- F代表**光纤**
				- BASE前面的数字代表数据率
					- BASE指**基带传输**
				- 全双工
				- 半双工
				- **曼彻斯特编码**
					- **自含时钟编码**
				- 快速以太网
					- 保持最短帧长不变，将一个网段的最大长度减少到100m，以提高以太网的数据传输率
						- 最短帧长不变
				- 10Base-T表示的是10Mbit/s，使用数字信号，使用**双绞线**
			- 吉比特以太网
				- 工作方式
					- 全双工
					- 半双工
				- 信道
					- 光纤
			- 10吉比特以太网
				- 只使用光纤
				- 只使用全双工方式
- IEEE 802.5
	
	- 令牌环网
- IEEE 802.8
	
	- 光纤联网
- IEEE 802.11
	- 无线局域网
	    * **无线局域网不需要在发送过程中进行冲突检测**
		- CSMA/CA协议
		- 逻辑链路控制
			- LLC
				- 建立和释放数据链路层的逻辑连接
				- 提供与高层的接口
				- 差错控制
				- 给帧加序号
		- 介质访问控制
			- MAC
				- 组帧
				- 拆帧
				- 比特差错检测
				- 寻址
				- 竞争处理
		- 数据帧类型
			- IBSS
			- From AP
			- To AP
				- RA
					- SA
						- DA
			- WDS
		- 无线局域网分类
			- 有固定基础设施无线局域网
				- 最小构件
					- 基本服务集
						- 孤立
						- 通过接入点AP连接到主干分配系统，接入另一个基本服务集，构成扩展服务集
			- 无固定基础设施无线局域网自组织网络
				- 无AP
				- 由平等状态移动工作站相互通信组成的临时网络
				- 各结点之间地位平等，中间结点都为转发结点，具有路由器功能
		- 无线局域网直接使用CSMA/CD时,将存在**隐蔽站问题和暴露站问题**
## 广域网
- **帧中继网**
- **ATM网**
### 主要特征
- 长距离网络
- 因特网核心部分
- 点到点连接
- 主机采用**层次结构方式**编址
### 组成
- 结点交换机与连接这些交换机的链路组成
### 结点交换机
- 储存转发式
### 广域网使用的协议主要在网络层
### 通信子网
- 分组交换技术
### OSI层次
- 物理层
- 数据链路层
- 网络层
### 广域网数据链路层协议
#### PPP协议(点对点协议)

- 使用串行线路通信的**面向字节(字符填充法)**的协议
- **字符填充方式**
    - **7E转变为7D 5E**
    - **7D转变为7D 5D**
- 组成
	- **链路控制协议LCP**
		- 扩展**链路控制协议(链路层协议)**
		- 身份验证功能
	- **网络控制协议NCP**
		- 每个不同的**网络层协议**要用到一个相应的NCP来配置
	- **将IP数据报封装到串行链路的方法**
		- 长度受到最大传送单元（MTU）的限制
- PPP帧结构
	- 帧定界符
		- 7E
	- 地址字段
		- FF
	- 控制字段
	- 信息部分
	- FCS
	- 帧定界符
- 特点
	- 只支持全双工链路
	- 不提供差错控制功能
	- 不需要流量控制
	- 差错检测
	- 封装成帧
	- 点对点协议
	- 透明传输
		- 异步线路
			- **字节填充**
		- 同步线路
			- **比特填充**
	- 多种网路协议
		- 封装的IP数据报可以采用多种协议
	- 最大传送单元MTU

#### HDLC协议

- 在同步网上传输数据、**面向比特(零比特填充法)**的**异步**数据链路层协议
- 站
	- 主站
	- 从站
	- 复合站
- **零比特填充法**
      - 标志字段为**01111110**
- 数据操作方式
	- 正常相应
		- 只能由主站启动
	- 异步平衡
	- 异步响应
- **不属于TCP/IP协议**
- 类型
	- **信息帧**
	- **监督帧**
	- **无编号帧**
- HDLC帧结构
	- 标志
	- 地址
	- 控制
	- 信息
	- 帧校验序列FCS
- 特点
	- 全双工通信
	- 所有帧采用CRC检验
	- 传输可靠性高
		- 提供可靠传输

## 数据链路层设备
### 网桥
- 以太网通过网桥连接成更大的以太网
- 工作位置：MAC子层
	- 处理对象：**帧**
- 特点
	- 寻址和路径选择
	- 网桥在不同或相同类型的LAN之间存储并转发帧
	- 有足够的缓冲空间
- 优点
	- 过滤通信量
	- 扩大物理范围
	- 可使用不同的物理层
	- 可互联不同类型的局域网
	- 提高可靠性
- 缺点
	- 增大时延
	- MAC子层没有流量控制功能
	- 不同MAC子层的网桥连接在一起，需要进行帧格式的转换
	- 只适用于用户数不多和通信量不大的局域网
- 类型
	- <u>*透明网桥*</u>
		- 选择的不是最佳路由
	- <u>*源路由网桥*</u>
		- 选择的是最佳路由
### 局域网交换机
- **交换式局域网**核心设备
- 多端口网桥
	- 交换机多个端口可以**并行传输**
	- **更新**转发表
	     - 转发表(源地址,接收端口)
	     - 操作
	          - 转发
	          - 丢弃
	          - 登记
	- 共享信道带宽，隔离冲突域
- 虚拟局域网
	- VLAN
		- 虚拟局域网（VLAN）是一组**逻辑**上的设备和用户，这些设备和用户**并不受物理位置的限制**，可以根据功能、部门及应用等因素将它们组织起来，相互之间的通信就好像它们在同一个网段中一样，由此得名虚拟局域网
	- 一个VLAN就是一个广播域，VLAN之间的通信是通过第3层的路由器来完成的
	- **VLAN不仅可以隔离冲突域，而且可以隔离广播域**
	- 交换机进行转发决策时使用的PDU是目的物理地址
	- **VLAN网的帧结构**在以太网帧结构中**增加4个VLAN标记**
	- VLAN通信
		- **路由器**
		- **三层交换机**
    - 要实现VLAN之间的通信，**<u>*必须通过路由器*</u>**
    - 同一个VLAN的主机可以**<u>*跨越多台交换机*</u>**
- 以太网三种数据转发方式
    - **直接交换方式**
        - 检测到目的地址字段,立即转发
        - 优点是速度快,延迟小
        - 缺点是可靠性差
    - **存储转发交换方式**
        - 接收完一个数据帧,并将其存入端口队列,再对数据帧进行差错检查,无差错时转发,有差错丢弃
        - 优点是可靠性高
        - 缺点是延迟大
    - **改进的直接交换方式**
        - 接收完数据帧的前64字节,检查有无差错,无差错时丢弃
        - 特点是兼顾了传输的可靠性和处理时延
- 独占带宽
### 共享式局域网与交换式局域网的区别

*    共享式局域网核心设备是**集线器**,交换式局域网核心设备是**交换机**
*    共享式局域网任何时候都只能有一个结点能够通过共享信道发送数据
*    交换式局域网多个端口之间可以<u>***并发传输***</u>

# 网络层
- **路由选择**是网络中的所有结点共同协调工作的结果;**流量控制**是收发两端共同协调工作的结果
- IP地址
- 路由寻址
## 网络层功能
- 为**主机**之间提供**逻辑通信**
- IP提供的是**不可靠的无连接的服务**
### 异构网络互连
- 两个以上的计算机网络，通过一定的方法，用一种或多种通信处理设备相互连接起来，构成更大的网络系统
- 异构性体现
	- 不同的寻址方案
	- 不同的网络接入机制
	- 不同的差错处理方法
	- 不同的路由选择机制
- 中继系统分类
	- 物理层中继系统
		- 中继器
		- 集线器
	- 数据链路层系统
		- 网桥
		- 交换机
	- 网络层中继系统
		- 路由器
	- 网络层以上中继系统
		- 网关
- IP网络
	- 使用IP的虚拟互联网络
### 路由与转发
- 路由器功能
	- 路由选择
		- 根据路由协议构造路由表
	- 分组转发
		- 处理通过路由器的比特流
- 根据目的站完整地址进行路由的选择称为**主机路由**
- 根据目的站部分地址进行路由的选择称为**网络路由**
- 根据不确定的目的站地址进行路由的选择称为**缺省路由**
- 路由器转发分组依据IP地址
- 分割广播域
- **物理层、数据链路层、网络层协议可以不同**
### 拥塞控制
- 出现过量分组而引起网络性能下降的现象
	- 随着通信子网负载的增加，吞吐量反而降低
- 获取网络中发生的拥塞信息，利用这些信息进行控制，避免由于拥塞而出现分组的丢失，以及严重拥塞而产生网络<u>***死锁***</u>的现象
- 控制方法
	- **开环控制**(事先)
		- 静态方法
		- 根据用户的协议限制进入网络的交通，从而阻止拥塞的发生(预先规定)
		- 需要预留资源
	- **闭环控制**(事后)
		- 动态方法
		- 在拥塞已经发生或即将发生的时候作出反应，调节交通流
		- 不需要预留资源
### 网络层传输单元
- IP数据报
- 分组
## 路由算法
### 静态路由与动态路由
- 静态路由算法
	- **由管理员手工配置路由信息**
- 动态路由算法
	- 距离-向量路由算法（分散性）
		- 所有结点都定期地将它们的整个路由选择表传送给所有与之直接相邻的结点
		- 实质：迭代计算一条路由中的站段数或延迟时间，从而得到到达一个目标的最短的通路
		- 路由选择表
			- 每条路径的目的地
			- 路径的代价
		- RIP算法
			- **跳数**
				- 用源端口到达目的端口所经过的路由个数
				- 每经过一个路由器，跳数加一
		- 更新路由选择表
			- 新的路由在本结点的路由表中**不存在**，此时本地系统**加入**这条新的路由
			- 发来的路由信息中有一条到达某个目的地的路由，该路由与当前使用的路由相比，**有较短距离,替换**原先路由
		- 每个结点仅与它的**直接**邻居交谈
		- 慢收敛
			- 导致发生路由回路
			- **好消息传的快，坏消息传的慢**
	- 链路状态路由算法（全局性）
		- 路由器的链路状态只涉及相邻路由器的连通状态，而与整个互联网的规模并无直接的关系
		- 在一个链路状态路由选择中，一个结点检查所有直接链路的状态，并将所得的状态信息发送给网上的**所有其他结点**，而不是仅送给那些直接相连的结点
		- OSPF具有**最高的可靠性**
		- OSPF算法
			- 每个路由器在自己的链路发生变化时，将链路状态信息用**洪泛法**传送给网络中的其他路由器
			- 问候分组，如果在**40s**类没有从特定的邻居接收到这个分组，就认为这个邻居不存在了
		- 每个结点通过广播形式与其他所有结点交谈
## 层次路由
### 概念
- 将互联网分成许多较小的自治系统，系统有权决定自己内部采用什么路由协议
### 自治系统AS
- IGP内部网关协议
	- RIP
		- UDP
	- OSPF
		- IP
- EGP外部网关协议
	- BGP
		- TCP
## IPv4
- **IP协议是被路由协议**
- **OSPF协议是路由协议**

### IPv4分组

- 一个IP分组由首部和数据两部分组成
	- 首部
		- 版本
		- 首部长度
			- 一般为20B
		- 总长度
		- 标识
			- 计数器
		- 标志
			- 中间位
				- DF=1
					- 禁止分片
				- DF=0
					- 允许分片
			- 最低位
				- MF=1
					- 后面还有分片
				- MF=0
					- 后面没有分片
		- 片偏移
			- 分片后，某片在原分组中的相对位置
			- **每个分片一定是8字节的整数倍**
		- 首部校验和
		    - **只检验分组首部**
		- 生存空间（TTL）
			- <u>*确保分组不会永远在网络中循环*</u>
			- 路由器转发分组前，TTL减一
			- TTL等于0，丢弃
		- 协议
			- 6字段值
				- TCP
			- 17字段值
				- UDP
		- 源地址字段
		- 目的地址字段
		    - IP地址是一个32位的二进制，它通常**采用点分十进制表示**
	- 数据
	
- **基本单位**
	- **首部长度**
		- **4B**
	- **总长度**
		- **1B**
	- **片偏移**
		- **8B**
	
- IP数据报分片
	- IP数据报的总长度大于链路MTU
	- 标识
	- MF(**More Fragment**)
		- 起始1
		- 末尾0
	- DF(**Don't Fragment**)
		- 0
	
- IP数据报分片规则
     $$
     数据报总长度=IP首部长度(20B)+总待传数据部分
     $$

     $$
     最大传输单位MTU=IP首部长度(20B)+单个分组数据长度(必须是8B的整数倍)
     $$

     $$
     分组数=\frac{总数据部分}{单个分组数据长度}
     $$
### 虚拟专用网VPN
- 本地地址
    - 一个机构内部的计算机可以由本机构自行分配其IP地址
    - 仅在本机构有效
- 全球地址
    - 全球唯一IP地址
- 专用地址
    - 在因特网中的所有服务器,对目的地址是**专用地址**的数据报**一律不进行转发**
    - 采用这样的专用IP地址的互联网络叫做**专用互联网**或**本地互联网**,专用IP地址也叫**可重用IP地址**
- **虚拟专用网VPN**
    - **利用共用的因特网作为本机构各专用网之间的通信载体**
    - 一个机构要构建自己的VPN就必须为它的每一个场所购买专门的硬件和软件,并进行配置,使每一个场所的VPN系统都知道其他场所的地址
    - <u>***主要目的是为了数据保密***</u>
### 网络地址转换NAT
- 实现**专用网络地址**和**公用网络地址**之间的相互转换
- 将专用网络地址转换为共用地址，从而对外隐藏内部管理的IP地址
- 私有地址只用于LAN，不用于WAN连接，并且允许私有IP地址被LAN重复利用
- NAT软件
	- **至少一个有效的外部全球地址**
- NAT路由器在**转发**以及**接收**IP数据报时，一定要更换其IP地址
- 步骤
    - NAT路由器收到从专用网内部的主机A发往因特网上主机B的IP数据报,根据NAT地址转换表进行IP地址转换,变为**新的源IP地址**,然后转发出去
    - 主机B收到这个IP数据报之后,以为A的IP地址是**新的源IP地址**,发送应答时的IP数据报的目的IP地址是**NAT路由器的IP地址**
    - 当NAT路由器收到因特网上的主机B发来的IP数据报时,还要进行一次IP地址的转换,通过NAT地址的转换,就可以把目的IP地址转换为主机A真正的本地IP地址
- 当NAT路由器具有n个全球IP地址时,专用网内最多可以同时有n个主机接入到因特网
### 子网划分
- 主机分配**32位/4字节**全球唯一标识符，即IP地址

- 分类
    - **单播地址**
	    - A类
        $$
        [1,126]=[0,2^7-2],子网掩码255.0.0.0
        $$
        **最高位0，拥有最多的主机数**
	    - B类
        $$
        [128,191][2^7,2^7+2^6-1],子网掩码255.255.0.0
        $$
        **最高位10**
	    - C类
	    $$
	    [192,223]=[2^7+2^6,2^7+2^6+2^5-1],子网掩码255.255.255.0
	    $$
	    **最高位110，拥有最少的主机数**
	- **多播地址**
	    - **D类**
    	    - **组播地址**
    	    $$
    	    224.0.0.0\sim239.255.255.255
            $$
	- E类
	- **私有地址**
	
    IP地址|掩码长度|主机数
    ---|---|---
    **10**.0.0.0~**10**.255.255.255|8|16777216
    **172.16**.0.0~**172.31**.255.255|12|1048576
    **192**.168.0.0~**192**.168.255.255|16|65536
    - **0.0.0.0只能作为本主机在本网络的源IP地址**
    - 默认路由<u>***0.0.0.0/0***</u>
    - 不同**类别的地址要对应不同类别的子网掩码**,否则会导致认为不在同一个子网中
    
- 记法(<u>***转换***</u>)
	
	- 点分十进制记法
	- 二进制记法
	
- 二级IP地址
	
	- 网络号和主机号两部分组成
		$$
		IP地址::={<网络号>,<主机号>}
		$$
	
- 主机号
	- **主机号全为0表示"本主机"所连接到的单个网络地址**
	- **主机号全为1表示网络的广播地址**
	
- IP地址是标志一台主机和一条链路的接口

- 网络号字段全0的IP地址是保留地址,意思是"本网路"

- 用转发器和桥接器连接的若干LAN仍然是同一个网络

- 所有形如**127.xx.yy.zz**的IP地址，都作为**保留地址**，用于回路测试

- 一台主机有多个地址,说明这个主机属于两个或两个以上的逻辑网络

- 如果一台主机有两个或两个以上的IP地址，那么说明这台主机属于两个或者两个以上的逻辑网络

- 子网划分与子网掩码
	- 子网划分
		- 划分子网只是**把IP地址的主机号这部分再进行划分**，而不改变IP地址
		- 三级IP地址
		$$
		IP地址::={<网络号>,<子网号>,<主机号>}
		$$
		
  - 子网掩码
        $$
        网络地址=子网掩码\times IP地址
	      $$
		- 与IP地址相对应的、长32比特的二进制字符串
		- 子网掩码是为了获得IP的网络地址，然后供路由器进行路由选择
		- **网络号和子网号全一，主机号全零**
			- 全零位数对应主机号位数
		- 0.0.0.0只能作为IP分组的源IP地址但不能作为目的IP地址
		- 默认路由为0.0.0.0/0
		- 一台主机在设置IP地址信息的同时，必须设置子网掩码
		- 子网掩码定义了**子网中网络号的位数**
		- 子网掩码可以**把一个网络进一步划分为几个规模相同的子网**
		$$
		子网个数=2^n-2,主机个数=2^n-2
		$$
### 无分类域间路由选择CIDR
- 作用
  
    - **将小的网络汇聚成超网**
- 特点
	- 消除A、B、C类地址及划分子网的概念，更有效分配IPv4的地址空间
	
	- 将网络前缀都相同的连续IP地址组成CIDR地址块
		- CIDR记法;IP地址后加上“/”，然后写上网络前缀的位数
			- 最小地址
			- 最大地址
		
	- CIDR地址块中的地址数一定是2的整数次幂
	
	- 融合子网地址与子网掩码，方便子网划分
	
	- 网络前缀越短，其地址块所包含的地址数就越多
	
	- 网络前缀越长，其地址块越小，路由越具体
	
	- **CIDR允许子网位全一或全零**
	     $$
	     子网个数=2^n
	     $$
	     
	- 地址掩码
		- 主机号全为零
		- 网络前缀全为一
- **最长前缀匹配**
	- 使用CIDR时，路由表中的每个项目由"网络前缀"和“下一跳地址”组成
	- 使用CIDR时，查找路由表可能得到几个匹配结果，应选择具有最长网络前缀的路由
		- 前缀越长，地址块越小，路由越具体
- CIDR查找路由方法
	
	- 二叉搜索
- **构成超网**
	- <u>***将多个子网集合成一个较大的子网，构成超网，或路由聚合***</u>
	- 方法：将网络前缀缩短
### 路由聚合CIDR
- 概念
	- 将网络前缀都相同的连续的IP地址组成“CIDR”数据块
- 目的
	- 减少路由表表项和路由器间的信息交换
- 方法
	- 把一串IP地址都写为二进制表示，取最长的公共前作为网络号
- 表示
$$
IP地址::={<网络前缀>,<主机号>}
$$
- 规则
    - 最长地址匹配
### 协议
- 反向地址解析协议**RARP**
  
    - 通过MAC地址找到IP地址
- 地址解析协议**ARP**
	![image-20210818234403578](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20210818234403578.png)
	- ARP表
		- IP地址
			- 网络层使用地址（IP）
		- 硬件地址
			- 数据链路层使用地址（MAC）
		- 作用
			- 找到<u>***MAC***</u>帧
			- 广播ARP请求分组
				- 广播
			- 单播ARP响应分组
				- 单播
	- 4种典型情况
		- 发送方是主机时，把IP数据报发送到本网络中的另一台主机，用ARP找到目的主机的硬件地址
		- 发送方是主机时，要把IP数据报发送到另一个网络的一台主机，用ARP找到本网络上的一个路由器的硬件地址，剩下的工作交给路由器完成
		- 发送方是路由器时，把IP数据报转发到本网络的一台主机，用ARP找到目的主机的地址
		- 发送方是路由器时，把IP数据报转发到另一台网络上的主机，用ARP找到本网络上的一个路由器的硬件地址，剩下的工作由找到的这个路由器完成
- 动态主机配置协议**DHCP**
	- 动态分配IP地址
	- 允许地址重用
	- **应用层协议**
	- 使用客户/服务器方式
	- 客户端和服务端通过广播方式进行交互
	- 基于UDP
	- 即插即用联网机制
	- 流程
		- 主机广播DHCP发现报文(DHCPdiscover)
		- DHCP服务器广播DHCP提供报文(DHCPoffer)
		- 主机广播DHCP请求报文(DHCPrequest)
		- DHCP服务器广播DHCP确认报文(DHCPack/DHCPnak)
- 网际控制报文协议**ICMP**
    - 主机或路由器报告差错和异常情况
    - IP直接为ICMP服务
    - ICMP报文传输方式是放在**IP数据报数据字段**中传送
    - ICMP报文种类
    	- 差错报文
			- <u>***终点不可达***</u>
				- 无法交付
			- **<u>*源点抑制*</u>**
				- **<u>*拥塞*</u>**丢数据
			- 时间超过
				- TTL=0
			- 参数问题
				- 首部字段有问题
			- 改变路由（重定向）
				- 值得更好地路由
		- 询问报文
			- **PING**
	            - 网络**连通性**
	            - 它是用来检查网络是否通畅或者网络连接速度的命令
			- Tracert
	            - 用 IP 生存时间 (TTL) 字段和 ICMP 错误消息来确定从一个主机到网络上其他主机的路由
## IPv6
### IPv4到IPv6技术
- <u>*双协议栈技术*</u>
- <u>*隧道技术*</u>
- <u>*网络地址转换技术*</u>
### 组成
- 首部40B
- 地址长度**16B**，也就是**128bit**
### IPv6的特点
- 从**根本上解决**IP地址耗尽的问题
- 特点
	- 更大的地址空间
	- **不允许分片**
	- **<u>*无首部校验和*</u>**
	- 扩展的地址层次结构
	- 灵活的首部格式
	- 改进的选项
	- 允许协议继续扩充
	- 支持即插即用
	- 支持资源的预分配
- 优点
	- 更长的地址
	- 简化了IP分组头
	- 更好地支持选项
### IPv6地址
- 地址类型
	- 单播
	- 多播
	- 任播
- 分级
	- 第一级
		- 全球知道的拓扑
	- 第二级
		- 指明单个场点
	- 第三级
		- 指明单个网络接口
- IPv6缩写
	- ::
		- **有且仅使用一次**
		- 多个0组使用一对冒号表示
    - **每个组的前导0可以省略**   
- IPv6不允许分片
- 过渡
	- 双协议栈
		- IPv4
		- IPv6
	- 隧道技术
		- IPv6封装到IPv4中
## 路由协议
### 内部网关协议IGP
- RIP路由协议
	- 分布式的基于距离向量的路由选择协议
		- 因特网协议标准
	- **应用层协议**
	- 域内路由协议
	- **使用UDP**
	- 距离向量路径
	- 跳数
		- 从自己到其他每一个目的网络的唯一最佳方案
		- 最多只能包含15个路由器,**最大跳数为15**
			- **16表示网络不可达**
	- 只适用于小互联网
	- 特点
		- 仅和相邻路由器交换信息
		- 路由器交换的信息是当前路由器知道的全部信息，即自己的路由表
		- **好消息传的快,坏消息传的慢**
		- 固定时间间隔交换路由信息
			- 30秒
		- 若干RIP广播后，所有路由器最终都知道整个IP的路由表
			- 收敛
	- 距离向量算法
		- **修改相邻路由器发来的RIP报文中所有的表项**
			- **下一跳路由器修改**
			- **距离字段加一**
		- **对修改后的RIP报文中的每一个项目,进行以下步骤**
			- **R1路由表中若没有Net3,则把该项目填入R1路由表**
			-  **R1路由表中若有Net3,则查看下一跳路由器地址:若下一跳是x,则用收到的项目替换源路由表中的项目;若下一跳不是x,原来距离比从x走的距离远则更新,否则不作处理**
		- 如果**180s**还没有收到相邻路由的更新路由表，把此路由表记为不可达路由器
		- 返回
- OSPF路由协议
	- OSPF向**本自治系统中的所有路由器**发送信息
		- **洪泛法**
	- 发送的信息是与本路由器相邻的**所有路由器的链路状态
	- 区域
		- 适用于更大的网络
	- 不会出现RIP“坏消息传的慢”问题
	- **OSPF是网络层协议**
	- 域内路由协议
	- **使用IP**
	- **链路状态协议**
	- 链路状态数据库
		- **全网拓扑结构图**
			- **Dijkstra最短路径算法**
	- 分组类型
		- 问候分组
		- 数据库描述分组
		- 链路状态请求分组
		- 链路状态更新分组
		- 链路状态确认分组
	- 每隔十秒相邻路由器交换一次问候分组,如果在**<u>*40s*</u>**之内没有从特定的邻居接收到这种分组，路由器就认为那个邻居不存在了
	- 只要一个路由器的链路发生变化，该路由器就要使用链路状态更新分组，用洪泛法向全网更新链路状态
	- 一个路由器的链路状态只涉及与相邻路由器的连通状态，与整个互联网的规模并无直接关系
	- 为了使OSPF能够用于规模很大的网络,OSPF将一个自治系统再划分为若干个更小的范围,称为**区域**
### 外部网关协议EGP
- **BGP路由协议**（边界网关协议）
	- 不同自治系统的路由器之间交换路由信息的协议
	- 力求寻找到一条能够到达目的网络且比较好的路由，而并非是寻找一条最佳路由
	- 交换网络的可达性信息
		- 到达某个网络所要经过的一系列AS
	- **使用TCP**
	- **域间路由协议EGP**
	- **应用层协议**
	- 路径向量协议
	- 特点
		- BGP交换路由信息的结点数量是自治系统的数量级
		- 自治系统之间的路由选择不会过分复杂
		- 支持CIDR
	- 报文
		- 打开报文
		- 更新报文
		- 保活报文
		- 通知报文
## IP组播
### 组播概念
- 组播一定仅用于UDP
- 使用D类地址
- 源主机一次发送的单个分组可以抵达用一个组地址标识的若干主机，并被他们正确接收
- 源主机把单个分组发送给一个组播地址，该组播地址标识一组地址，网络把这个分组的副本投递给改组中的每台主机
- 主机使用一个成为IGMP的协议加入组播组
	- IGMP
- 组播路由避免路由环路
	- 构造组播转发树
- 组播需要路由器的支持才能实现
	- 能够运行组播协议的路由器成为组播路由器
    - 如果一个不运行组播路由器的网络遇到了一个组播数据报，那么它会对组播数据报再次封装，使之变为单一目的站发送的单播数据报，然后发送
### IP组播地址
- 组播数据报使用**D类IP地址**作为目的地址，首部中的协议字段值为2，表明使用IGMP
	- **224.0.0.0~239.255.255.255**
- 应用于**UDP**
- 组播数据报**尽最大努力交付**，不提供可靠交付
- 组播地址**只能用于目的地址，而不能用于源地址**
- 组播数据报不产生ICMP差错报文
- **并非所有D类地址都可作为组播地址**
- 源地址总是**单播地址**
- 采用了隧道技术后，如果一个运行组播路由器的网络遇到了一个非组播路由器，那么它会对组播数据报**再次进行封装**，使之变为单一目的站发送的单播数据报，然后发送
### 硬件组播
- 组播MAC地址
- 01-00-5E开头
- IP地址与MAC地址进行映射
### IGMP与组播路由选择协议
- 组播路由选择协议
	- 实际上是要找出以源主机为根结点的主播转发树，其中每个分组在每条链路上只传送一次
- 让路由器知道本局域网上是否有主机的进程参加或退出了某个组播组
## 移动IP
### 移动IP的概念
- 满足移动结点在移动中保持其连接性而设计
- 功能实体
	- 移动结点
	- 本地代理
	- 外部代理
### 组成
- 移动结点
- 本地代理
- 外部代理
### 移动IP通信过程
- 本地地址
- 外地代理
- 永久地址(归属地址/主地址)
	- <u>***固定***</u>
- 转交地址(辅地址)
	- <u>***动态改变***</u>
- 如果一个站点的用户希望实现漫游，那么它必须先建立一个本地代理；如果一个站点允许其他的访问者进入到它的网络中，那么它必须创建一个外部代理；当移动主机在一个外地站点中启动的时候，它与当地的外部代理联系，并且进行注册；然后，外部代理与该用户的本地代理进行联系，并且交给它的一个转交地址
- 当一个分组到达用户的本地局域网的时候，它被转发给某一台与局域网相连接的路由器。该路由器寻找目标IP主机，这时候本地代理相应该请求，并且接受该分组；然后讲这些分组封装到一些新IP分组中，并将新分组发送给外部代理。外部代理将原分组分解出来之后，移交给移动后的主机
## 网络层设备
### 路由器
- 路由器仅根据**目的主机所连接的网络号**来转发分组,减小了路由表所占的储存空间以及查找路由表的时间
- 路由器路由功能与转发功能
    - 转发即当分组到达路由器所采取的动作，当路由器收到分组，就在路由表查找分组对应的输出线路
    - 路由负责确定分组应该送到哪一个线路上，负责填充和更新路由表
- 路由的组成与功能
	- 路由器时一种具有多个输入端口和多个输出端口的专用计算机
	- 功能
		- 路由计算
- 组成
	- 控制部分
		- 路由选择处理机
		- 路由选择协议
		- 路由表
	- 转发分组
		- 交换结构
		- 输入端口
		- 输出端口
- 路由表与路由转发
    - 转发即当一个分组到达的时候所采取的动作，当路由器收到一个分组，路由器就在路由表中查找分组所对应的输出线路，通过查得的结果，将分组发送到正确的线路上去
    - 路由算法是网络层软件的一部分，负责确定一个进来的分组应该被传送到哪一条输出线路上。路由算法负责填充和更新路由表，转发功能则根据路由表的内容来确定当每个分组到来的时候应该采取什么动作
	- 路由选择部分(**最长前缀匹配原则**)
		- 路由选择处理器
		- 路由选择协议
		- 路由表
    - 分组转发部分
        - 交换结构
        - 输入端口
        - 输出端口
	- 组成
		- **目的网络IP地址**
		- **子网掩码**
		- **下一跳IP地址**
    - 步骤
        - 从收到的数据报的首部提取目的IP地址
        - 先判断是否为直接交付
        - 若路由表中有目的地址为D的特定主机路由,则把数据报传送给路由表中所指明的下一跳路由器
        - 否则,对路由表中的每一行(目的网络地址,子网掩码,下一条地址),用其中的子网掩码和D逐位相与,其结果为N.若N与该行的目的网络地址匹配,则把数据报传送给该行指明的下一跳路由器
        - 否则,若路由器有一个**默认路由**,则把数据报传送给路由表中所指明的默认路由器
        - 否则,报告转发分组出错
- **路由表中的默认路由的地址和子网掩码都是0.0.0.0**
- 相同网段的主机无需路由器即可正常通信
- 不同网段的主机需要路由器才能正常通信，并且要设置正确的**默认网关(NAT地址)**,才能与因特网通信
- 决定路由器转发表中的值的算法是**路由算法**
- 一个路由器至少应当有**两个不同的IP地址**,因为一个路由器至少应当连接到两个网络
- 路由器
	- 优点
		- 适用于大规模的网络
		- <u>*连接异构网络*</u>
		- 复杂的网络拓扑结构，负载共享和最优路径
		- 能更好地处理多媒体
		- 安全性高
		- 隔离不需要的通信量
		- 节省局域网的频宽
		- 减少主机负担
		- <u>抑制网络风暴</u>
		- <u>*分割冲突域和广播域*</u>
		- 路由器是网络层设备，处理的是网络层以下的功能
			- 物理层
			- 数据链路层
			- 网络层
	- 缺点
		- 它不支持非路由协议
		- 安装复杂
		- 价格高
- **当某个路由器发现一IP数据报的检验和有差错时，为什么采取丢弃的办法而不是要求源站重传此数据报？计算首部检验和为什么不采用CRC检验码？**
    - **纠错控制由上层（传输层）执行IP首部中的源站地址也可能出错请错误的源地址重传数据报是没有意义的不采用CRC简化解码计算量，提高路由器的吞吐量**
# 传输层
## 传输层提供的服务
### 传输层功能
- 提供进程之间的逻辑通信
	- **会话**之间的**端到端通信**
	- **进程**之间提供**逻辑通信**
- 复用和分用
	- 复用
		- 发送方不同的应用程序都可以使用同一个传输层协议传输数据
	- 分用
		- 接收方的传输层在剥去报文的首部之后能够把这些数据正确交付到目的应用进程
- 差错检测
	- 首部
	- 数据
- 面向连接的TCP
    - 可靠性较高
- 无连接的UDP
    - 高效率但不可靠
- 连接管理
    - **三次握手建立**
    - **四次握手释放**
### 传输层寻址与端口
- 端口
	- 让应用层的各种应用进程将其数据通过端口向下交付给传输层，以及让传输层知道应当将其报文段中的数据向上通过端口交付给应用层的相应进程
	- 传输层服务访问点
	- 标识组集中的应用进程
	- <u>**16位**端口号</u>
- 端口号
	- 范围分类
		- 服务端使用端口号
		- 客户端使用端口号
			- 仅在客户进程之间的才动态选择
	- 只有本地意义
	- 16bit
	- 熟知端口<u>***(0~1023)***</u>
应用程序|FTP    |TELNET |SMTP   |DNS    |TFTP   |HTTP   |SNMP
---     |---    |---    |---    |---    |---    |---    |---
熟知端口|21,20  |23     |25     |53     |69     |80     |161
- 套接字Socket

$$
套接字=(主机IP地址，端口号)
$$

- 唯一标识网络中的一台主机和其上的一个应用进程
- 只有**本地意义**
- **TCP和UDP都有端口号,二者不会互相干扰，可以共存于同一台主机**

### 无连接服务和面向连接服务
- 无连接服务
	- 两个实体之间的通信不需要先建立好连接，直接发送
		- UDP
			- 应用
				- **TFTP**
					- **小文件传输协议**
				- DNS
				    - 域名系统
				- SNMP
				    - 简单网络管理协议
				- RTP
					- 实时传输协议
				- RIP
				    - 路由信息协议
- 面向连接服务
	- 在通信之前，必须先建立连接，在通信过程中，整个连接的情况一直实时地监控和管理
		- TCP
			- 应用
				- **FTP**
					- **文件传输协议**
				- HTTP
					- 超文本传输协议
				- TELNET
					- 远程登录
				- SMTP
				    - 简单邮件传送协议
### 尽最大努力交付
* 不保证源主机发送的IP数据报一定无差错地交付到目的主机
* 不保证源主机发送的IP数据报都在某一规定的时间内交付到目的主机
* 不保证源主机发送的IP数据报一定按发送时的顺序交付到目的主机
* 不保证源主机发送的IP数据报不会重复交付给目的主机
* 不故意丢弃IP数据报
## 流量控制与可靠传输机制
### 流量控制
- 由接收方控制发送方发送数据的速率
	- 停止-等待协议
		- 发送方每发送一帧，等待接收方应答信号，之后发送下一帧
		- 效率低
	- 滑动窗口协议
		- 发送窗口
			- 发送方流量控制
		- 接收窗口
		- 实现以字节为单位的确认
- 接收方收不下数据就不回复确认
- 相邻结点
- 糊涂窗口综合征是<u>***流量控制***</u>问题
### 可靠传输机制
- 可靠指的是使用**确认机制**和**重传机制**来确保传输数据的不丢失
- 确认
	- 无数据控制帧
- 超时重传
- 自动重传请求
	- 停止-等待ARQ
		- 信道利用率低
		- 逐帧传送
		- 帧缓冲区
			- 确认帧ACK
				- 之前的帧确认接收
		- 差错
			- 数据帧丢失
				- **超时计时器**
			- **ACK丢失**
                - 丢弃重复的帧,重传对该帧的确认帧
			- **ACK迟到**
                - 发送端收下迟到的确认帧,什么也不做
		- 超时机制
			- 每次发送一个帧就启动一个计时器
			- 发送完一个帧后，必须**保留它的副本**,作为超时重传使用
			- 数据帧和确认帧必须编号
			- <u>*超时重传*</u>
	- 后退N帧GBN(连续ARQ)
		- 连续发送帧
			- 接收方只允许连续发送帧
		- 采用n比特对帧编号，发送窗口的尺寸应满足
		- GBN发送方
			- 维持一组连续的允许发送的帧的序号
			- 上层调用
			- 收到ACK确认帧
				- **<u>*累积确认*</u>**
					- 对n号帧确认采用的方式，表明接收方**已经收到n号帧和它之前的全部帧**
					- ACKN表示对第n号帧的确认，表示接收方已经正确接收到第n号及其以前的帧
			- 超时计时
		- GBN接收方
			- 维持一组连续的允许接收的帧的序号
	- 选择性重传SR(连续ARQ)
		- **只重传出现差错的数据帧或计时器超时的数据帧**
			- 出现差错
			- 超时
		- 每个发送缓冲区对应一个计时器，当计时器超时时，缓冲区的帧会重传
		- 采用n比特对帧编号，保证新窗口序号与旧窗口序号没有重叠部分，需要满足条件：
			- 接收窗口最大值时
		- SR发送方
			- 上层的调用
			- 收到ACK
				- 下界
					- 标记已接收
						- 滑动窗口
				- 标记已接收
			- 超时计时
		- SR接收方
			- 确认正确接收的帧
				- 不管按序
	- 对窗口大小为n的滑动窗口，最多可以有n-1帧已发送但没有确认
## UDP（6）
### 特点
- 无连接
- 首部开销小(**8B**)
- 最大努力交付(不可靠)
- 支持一对一/一对多/多对一和多对多的交互通信
- **应用层**要保证可靠性
- 面向**报文**，适合一次性传输少量数据的网络应用
    - UDP对应用程序交下来的报文，既不合并，也不拆分，在添加首部之后就向下交付IP层，一次交付完整的报文
- **无拥塞控制**，适合实时应用
- 接收端收到有差错的UDP用户数据时，直接丢弃
### UDP数据报
- 8B
	- 源端口号
	- 目的端口号
	- 长度
	- 校验和
	    - 检验范围：伪首部、UDP数据报的首部和数据
### UDP检验
- **计算检验和时**,要在UDP用户数据报之前增加**12字节的伪首部**
- UDP检验是把首部和数据部分一起都检验
- 只能是点对点连接
- 发送端
	- 填上伪首部
	- 全零填充校验和字段
	- 全零填充数据部分
	- 采用首部、伪首部、数据进行<u>***二进制反码运算求和再取反***</u>
	- 把和求反码填入检验和字段
	- 去掉伪首部，发送
- 接收端
	- 填上伪首部
	- 伪首部、首部、数据部分采用二进制反码求和
	- 结果全为1则无差错，否则丢弃数据报
- 校验和段的使用是可选的，如果源主机不想计算校验和，那么该校验和段应为全0
- 二进制反码运算后，当无差错时其结果应该全为1
- UDP虽然有差错校验机制，但是UDP的差错校验只是检查数据在传输的过程中有没有出错，出错的数据**直接丢弃**，没有重传机制
- **应用层协议**必须承担**可靠性**方面的全部工作
- UDP**不能保证**数据可靠性传输
## TCP（17）
### 特点

> 面向连接的/可靠的传输协议

- 有连接
    - 双方资源的开辟
        - 三次握手
- 面向连接
- 首部开销20B
- 一对一
- 提供可靠传输
- 每一个TCP连接唯一地被通信两端的两个端点所确定
    - 套接字Socket
- **全双工通信**
	- 发送缓存
		- 准备发送的数据
		- 已发送但未确认的数据
	- 接收缓存
		- 按序到达没有被应用程序接收
		- 不按序到达
- 面向**字节流**,提供以**字节为单位的确认,提供对分组的确认机制**
    - TCP对应用程序交下来的报文，视为无结构的字节流
- TCP协议规定HTTP服务器进程的端口号为80
### TCP段
- 20B(TCP报文长度必须是4B的整数倍)
	- 源端口
	- 目的端口
	- 序号
		- 序号字段的值表明本报文段所发送的数据的第一个字节的序号,单位1B
	- 确认号
		- 期望收到对方的下一个报文段的数据的第一个字节的序号
	
	- 数据偏移
		- 指出TCP报文段的数据起始处距离TCP报文段的起始处有多远
		- **单位：4B**
	- 保留字段
		- 保留为今后使用
			- 置为0
	- 控制位
		- 紧急位URG
			- URG=1，表明紧急指针有效
				- 优先处理
		- 确认位ACK
			- ACK=1时确认号有效
			- ACK=0时确认号无效
		- 推送位PSH
			- PSH=1，尽快交付给接收应用进程
		- 复位位RST
			- RST=1，表明TCP出现差错，必须释放连接
		- 同步位SYN
			- SYN=1，表明是一个<u>***连接请求***</u>/<u>***连接接收报文***</u>
		- 终止位FIN
			- FIN=1，<u>***表明已经发送完毕***</u>
	- 窗口字段（rwnd/cwnd）
		- 发送本报文段的一方的接收窗口，即现在允许对方发送的数据量
		- 作为接收方让发送方设置其发送窗口的依据
	- 校验和
		- 检验首部+数据
	- 紧急指针字段
		- URG=1时才有意义，指出本报文中紧急数据的字节数
	- 选项字段
	- 填充字段
		- 使整个首部长度是4B的整数倍
	
- 一个TCP报文段数据部分最多**65495个字节(2^16-1-20-20)**
### TCP连接管理
- TCP连接的建立
    - 三个阶段

        - 连接建立
        - 数据传送
        - 连接释放
        
    - 采用的都是客户/服务器方式

    - 三次握手建立

      ![image-20210815220342623](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20210815220342623.png)

      - 客户端发送连接请求报文段，无应用层数据[S]
      	- SYN=1
      	- ACK=0
      	- seq=x（随机）
      - 服务器端为该TCP连接分配缓存和变量，并向客户端返回确认报文段，允许连接，无应用层数据
      	- SYN=1
      	- ACK=1
      	- seq=y（随机）
      	- ack=x+1
      - 客户端为该TCP连接分配缓存和变量，并向服务器端返回确认的确认，可以携带数据
      	- SYN=0
      	- ACK=1
      	- seq=x+1
      	- ack=y+1

    - 产生SYN洪泛攻击
    	- 攻击者发送TCP SYN，SYN是TCP的第一个数据包，服务器返回ACK后，攻击者不发回ACK，导致死机
    	
    - TCP连接建立之后，服务开辟资源空间，形成消息传递（管道、FIFO、消息队列）

    - 套接字socket

    <center>socket=[IP,PORT]
- TCP连接的释放FIN/ACK
	- 四次握手释放
		- 客户端发送连接释放报文段，停止发送数据，主动关闭TCP连接
			- <u>***ACK=0***</u>
			- FIN=1
			- seq=u
		- 服务器端回送一个确认报文段，客户到服务器这个方向的连接就释放了（半关闭状态）
			- ACK=1
			- seq=v
			- ack=u+1
		- 服务器端发完数据，就发出连接释放报文段，主动关闭TCP连接
			- FIN=1
			- ACK=1
			- seq=w
			- ack=u+1
		- 客户端回送一个确认报文段，再等到时间等待计时器设置的2MSL（最长报文寿命）后，连接彻底关闭
			- ACK=1
			- seq=u+1
			- ack=w+1
- ack为期望收到的下一个序号
	- 期望下一个序号值
- TCP通信双方，有一方发送了带有FIN标志位的数据段后表示**单方面释放连接，表示本方已经无数据发送，但是可以接收对方的数据**
- A在TIME-WAIT状态必须等待2MSL时间
    - 保证A发送的最后一个ACK报文段能够到达B.ACK报文段可能会丢失,B在收不到确认的情况下会重传报文段,A就能在这个时间段内收到并重传一次确认.
    - 防止已失效连接请求报文段出现在本连接中
### TCP可靠传输
- 保证结束方进程从缓存区读出的字节流与发送方发出的字节流是完全一样的
- 校验
	- 伪首部
		- 与UDP校验一样
- 序号
	
	- 用来保证数据能有序提交给应用层
- 确认
	- 确认号为期待收到的下一个报文段第一个字节的序号
		- A和B建立了TCP连接，当A收到确认号为100的确认报文段时，表示末字节序号为99的报文段已经收到
	- 默认使用**累积确认**
	    - 如果有一个确认报文段丢失了，不一定会引起对方数据的重传
	- 对报文段的确认机制
- 重传
	
  - 采用自适应算法，动态改变重传时间RTTs（加权平均往返时间）
    $$
    RTT=(1-\alpha)\times(旧的RTT)+\alpha\times(新的往返时延样本)
	  $$
	- **超时重传**
		
		- 计时器到期还没收到确认则重传对应报文
	- **冗余确认**
		- 当收到失序报文时向发送端发送冗余ACK
		- **快速重传**
### 流量控制(点对点)
- 在确认报文中设置接收窗口rwnd的值来限制发送速率
	- 接收窗口rwnd
	- 拥塞窗口cwnd
	
- 利用滑动窗口机制是实现流量控制

- 发送方的发送窗口取接收窗口rwnd和拥塞窗口cwnd的最小值
    $$
    发送方发送窗口=min(rwnd,cwnd)=min(拥塞窗口，接收窗口)
    $$
    
- 发送窗口大小可以动态变化
$$
发送窗口类似于GBN:发送窗口=2^N-1,N为序号
$$

- A向B发送数据，连接建立时，B告诉A自己的rwnd
	- 当传输的数据丢失时，B发送一个减少的rwnd和ack，限制A发送窗口
	- TCP为每一个连接设有一个持续计时器，只要TCP连接的一方收到对方的零窗口通知，就启动持续计时器
	- 若持续计时器设置的时间到期，就发送一个零窗口探测报文段，接收方收到探测报文段时给出现在的窗口值
	- 若窗口仍然是0，那么发送方就重新设置持续计时器
- **TCP吞吐量计算公式**
$$
TP=\frac{W}{\frac{W}{R}+RTT},其中W为发送窗口大小，R为发送速率，RTT为往返时延
$$
### 拥塞控制(全局性)

- 原理
	- 根据自己估算的网络拥塞程度设置cwnd的值来限制发送速率
		- 拥塞窗口cwnd
	- **发送端**根据网路拥塞情况确认的窗口值
- 方法
	- **慢开始(注意不是慢"启动")**
		- 开始重传时,先令cwnd=1(先令cwnd=1后**才开始**采用慢开始算法)
		- 当cwnd<ssthresh时每收到一个报文段的确认cwnd加1
		- 在一个传输次数RTT内，cwnd呈底数为2的指数式增长
	- **拥塞避免**
		- 当cwnd>ssthresh时，每经过一个往返时延时cwnd加1
		- 在一个传输次数RTT内，cwnd呈线性增长
		- 拥塞后，更新ssthresh
	- **快重传**
		- 当收到连续的三个重复的ACK，直接重传对方期待的报文
	- **快恢复**
		- 当收到连续的三个冗余ACK，令ssthresh=cwnd=cwnd/2
		- 与慢开始不同的是拥塞窗口cwnd不是设置为1，而是设置为新的ssthresh
		- 采用快恢复算法时,慢开始算法只是在TCP连接建立时和网络出现超时时才使用
- 拥塞控制
	- ssthresh置为原cwnd的一半，cwnd置1(最大报文段**MSS**)
- 超时
    - 发生超时，启动慢开始或者快恢复
- **死锁**
    - 当提供的负载继续增大到某一数值时，网络的**吞吐量下降到零**
- **拥塞**
    - 到达通信子网中某一部分的分组数量过多，使得该部分乃至**整个网络性能下降的现象(还未下降到零)**

## socket

### 函数API

```c
int socket(int domain, int type, int protocol);
```

- domain：即协议域，又称为协议族（family）。常用的协议族有，AF_INET、AF_INET6、AF_LOCAL（或称AF_UNIX，Unix域socket）、AF_ROUTE等等。协议族决定了socket的地址类型，在通信中必须采用对应的地址，如AF_INET决定了要用ipv4地址（32位的）与端口号（16位的）的组合、AF_UNIX决定了要用一个绝对路径名作为地址。
- type：指定socket类型。常用的socket类型有，SOCK_STREAM、SOCK_DGRAM、SOCK_RAW、SOCK_PACKET、SOCK_SEQPACKET等等。
- protocol：故名思意，就是指定协议。常用的协议有，IPPROTO_TCP、IPPTOTO_UDP、IPPROTO_SCTP、IPPROTO_TIPC等，它们分别对应TCP传输协议、UDP传输协议、STCP传输协议、TIPC传输协议。

### socket基本概念

<center><b>socket=[IP,PORT]~[IP,PORT]，具备唯一性

socket 的原意是“插座”，在计算机通信领域，socket 被翻译为“套接字”，它是计算机之间进行通信的一种约定或一种方式。通过 socket 这种约定，一台计算机可以接收其他计算机的数据，也可以向其他计算机发送数据。

我们把插头插到插座上就能从电网获得电力供应，同样，为了与远程计算机进行数据传输，需要连接到因特网，而 socket 就是用来连接到因特网的工具。

socket 的典型应用就是 Web 服务器和浏览器：浏览器获取用户输入的 URL，向服务器发起请求，服务器分析接收到的 URL，将对应的网页内容返回给浏览器，浏览器再经过解析和渲染，就将文字、图片、视频等元素呈现给用户。

* 在服务器和主机进行连接通信时，建立socket，其中服务器端的端口依据协议而定，不会发生改变，而主机端的端口可以进行更改，其中最大支持65535<u>***（当用完65535后，再建立一个服务器端口进行通信，仍然最大支持65535）***</u>

![image-20210815222328982](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20210815222328982.png)

* 当连接建立，但是没有数据发送，消息队列无数据，此时应用程序可以读取队列，状态是BIO（同步阻塞）

> IO的方式通常分为几种，**<u>*同步阻塞的BIO、同步非阻塞的NIO、异步非阻塞的AIO*</u>**。
>
> - BIO是一个连接一个线程。
> - NIO是一个请求一个线程。
> - AIO是一个有效请求一个线程。
>
> 一、BIO
>
>    在JDK1.4出来之前，我们建立网络连接的时候采用BIO模式，需要先在服务端启动一个ServerSocket，然后在客户端启动Socket来对服务端进行通信，默认情况下服务端需要对每个请求建立一堆线程等待请求，而客户端发送请求后，先咨询服务端是否有线程相应，如果没有则会一直等待或者遭到拒绝请求，如果有的话，客户端会线程会等待请求结束后才继续执行。
>
> 二、NIO
>
>   NIO本身是基于事件驱动思想来完成的，其主要想解决的是BIO的大并发问题： 在使用同步I/O的网络应用中，如果要同时处理多个客户端请求，或是在客户端要同时和多个服务器进行通讯，就必须使用多线程来处理。也就是说，将每一个客户端请求分配给一个线程来单独处理。这样做虽然可以达到我们的要求，但同时又会带来另外一个问题。由于每创建一个线程，就要为这个线程分配一定的内存空间（也叫工作存储器），而且操作系统本身也对线程的总数有一定的限制。如果客户端的请求过多，服务端程序可能会因为不堪重负而拒绝客户端的请求，甚至服务器可能会因此而瘫痪。
>
>   NIO基于Reactor，当socket有流可读或可写入socket时，操作系统会相应的通知引用程序进行处理，应用再将流读取到缓冲区或写入操作系统。 也就是说，这个时候，已经不是一个连接就要对应一个处理线程了，而是有效的请求，对应一个线程，当连接没有数据时，是没有工作线程来处理的。
>
>   **<u>*BIO与NIO一个比较重要的不同，是我们使用BIO的时候往往会引入多线程，每个连接一个单独的线程；而NIO则是使用单线程或者只使用少量的多线程，每个连接共用一个线程。*</u>**
>
> ![img](http://images2015.cnblogs.com/blog/37237/201512/37237-20151222220329015-207666376.png)
>
> NIO的最重要的地方是当一个连接创建后，不需要对应一个线程，这个连接会被注册到多路复用器上面，所以所有的连接只需要一个线程就可以搞定，当这个线程中的多路复用器进行轮询的时候，发现连接上有请求的话，才开启一个线程进行处理，也就是一个请求一个线程模式。
>
>    在NIO的处理方式中，当一个请求来的话，开启线程进行处理，可能会等待后端应用的资源(JDBC连接等)，其实这个线程就被阻塞了，当并发上来的话，还是会有BIO一样的问题。
>
> 　　HTTP/1.1出现后，有了Http长连接，这样除了超时和指明特定关闭的http header外，这个链接是一直打开的状态的，这样在NIO处理中可以进一步的进化，在后端资源中可以实现资源池或者队列，当请求来的话，开启的线程把请求和请求数据传送给后端资源池或者队列里面就返回，并且在全局的地方保持住这个现场(哪个连接的哪个请求等)，这样前面的线程还是可以去接受其他的请求，而后端的应用的处理只需要执行队列里面的就可以了，这样请求处理和后端应用是异步的.当后端处理完，到全局地方得到现场，产生响应，这个就实现了异步处理。
>
> 三、AIO
>
>    与NIO不同，当进行读写操作时，只须直接调用API的read或write方法即可。这两种方法均为异步的，对于读操作而言，当有流可读取时，操作系统会将可读的流传入read方法的缓冲区，并通知应用程序；对于写操作而言，当操作系统将write方法传递的流写入完毕时，操作系统主动通知应用程序。 即可以理解为，read/write方法都是异步的，完成后会主动调用回调函数。

* 当应用程序想要发送数据时，不是直接发送给其目的主机，而是发送给消息队列，通过队列进行读写。从用户空间到内核的调用，是一系列I/O的操作。
* socket是I/O上队列的对应关系，具有唯一性。程序发送数据包到传输层，传输层通过该数据包将数据放在唯一指向的队列里。最终程序引用了这个队列，就可以通过内核，将数据搬运到用户空间。

#### UNIX/Linux

为了表示和区分已经打开的文件，UNIX/Linux 会给每个文件分配一个 ID，这个 ID 就是一个整数，被称为文件描述符（File Descriptor）。例如：

-    通常用 0 来表示标准输入文件（stdin），它对应的硬件设备就是键盘；
-    通常用 1 来表示标准输出文件（stdout），它对应的硬件设备就是显示器。

我们可以通过 socket() 函数来创建一个网络连接，或者说打开一个网络文件，socket() 的返回值就是文件描述符。有了文件描述符，我们就可以使用普通的文件操作函数来传输数据了，例如：

-    用 read() 读取从远程计算机传来的数据
-    用 write() 向远程计算机写入数据。

#### Windows

Windows 也有类似“文件描述符”的概念，但通常被称为“文件句柄”。因此，本教程如果涉及 Windows 平台将使用“句柄”，如果涉及 Linux 平台则使用“描述符”。

与 UNIX/Linux 不同的是，Windows 会区分 socket 和文件，Windows 就把 socket 当做一个网络连接来对待，因此需要调用专门针对 socket 而设计的数据传输函数，针对普通文件的输入输出函数就无效了。

### socket套接字类型

#### 流格式套接字（SOCK_STREAM）

流格式套接字（Stream Sockets）也叫“面向连接的套接字”，在代码中使用 SOCK_STREAM 表示。

SOCK_STREAM 是一种可靠的、双向的通信数据流，数据可以准确无误地到达另一台计算机，如果损坏或丢失，可以重新发送。

SOCK_STREAM 有以下几个特征：

-    数据在传输过程中不会消失
-    数据是按照顺序传输的
-    数据的发送和接收不是同步的（有的教程也称“不存在数据边界”）

流格式套接字可以达到高质量的数据传输，这是因为它使用了 TCP 协议（The Transmission Control Protocol，传输控制协议），TCP 协议会控制你的数据按照顺序到达并且没有错误。

你也许见过 TCP，是因为你经常听说“TCP/IP”。TCP 用来确保数据的正确性，IP（Internet Protocol，网络协议）用来控制数据如何从源头到达目的地，也就是常说的“路由”。

流格式套接字的内部有一个缓冲区（也就是字符数组），通过 socket 传输的数据将保存到这个缓冲区。接收端在收到数据后并不一定立即读取，只要数据不超过缓冲区的容量，接收端有可能在缓冲区被填满以后一次性地读取，也可能分成好几次读取。

也就是说，不管数据分几次传送过来，接收端只需要根据自己的要求读取，不用非得在数据到达时立即读取。传送端有自己的节奏，接收端也有自己的节奏，它们是不一致的。

#### 数据报格式套接字（SOCK_DGRAM）

数据报格式套接字（Datagram Sockets）也叫“无连接的套接字”，在代码中使用 SOCK_DGRAM 表示。

计算机只管传输数据，不作数据校验，如果数据在传输中损坏，或者没有到达另一台计算机，是没有办法补救的。也就是说，数据错了就错了，无法重传。

因为数据报套接字所做的校验工作少，所以在传输效率方面比流格式套接字要高。

SOCK_DGRAM 有以下特征：

-    强调快速传输而非传输顺序；
-    传输的数据可能丢失也可能损毁；
-    限制每次传输的数据大小；
-    数据的发送和接收是同步的（有的教程也称“存在数据边界”）。

总之，数据报套接字是一种不可靠的、不按顺序传递的、以追求速度为目的的套接字。

数据报套接字也使用 IP 协议作路由，使用 UDP 协议（User Datagram Protocol，用户数据报协议）。

## Linux虚拟服务器

 LVS（Linux Virtual Server）即Linux虚拟服务器,该项目在Linux内核中实现了基于IP的数据请求负载均衡调度方案

![image-20210818235951126](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20210818235951126.png)

终端互联网用户从外部访问公司的外部负载均衡服务器，终端用户的Web请求会发送给LVS调度器，调度器根据自己预设的算法决定将该请求发送给后端的某台Web服务器，比如，轮询算法可以将外部的请求平均分发给后端的所有服务器，终端用户访问LVS调度器虽然会被转发到后端真实的服务器，但如果真实服务器连接的是相同的存储，提供的服务也是相同的服务，最终用户不管是访问哪台真实服务器，得到的服务内容都是一样的，整个集群对用户而言都是透明的。最后根据LVS工作模式的不同，真实服务器会选择不同的方式将用户需要的数据发送到终端用户，LVS工作模式分为NAT模式、TUN模式、以及DR模式。

### 基本术语

- DS：Director Server。指的是前端负载均衡器节点。
- RS：Real Server。后端真实的工作服务器。
- VIP：向外部直接面向用户请求，作为用户请求的目标的IP地址。
- DIP：Director Server IP，主要用于和内部主机通讯的IP地址。
- RIP：Real Server IP，后端服务器的IP地址。
- CIP：Client IP，访问客户端的IP地址

### LVS-NAT

![image-20210819225357446](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20210819225357446.png)

1. 当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP

2. PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链

3. IPVS比对数据包请求的服务是否为集群服务，若是，修改数据包的目标IP地址为后端服务器IP，后将数据包发至POSTROUTING链。 此时报文的源IP为CIP，目标IP为RIP

4. POSTROUTING链通过选路，将数据包发送给Real Server

5. Real Server比对发现目标为自己的IP，开始构建响应报文发回给Director Server。 此时报文的源IP为RIP，目标IP为CIP

6. Director Server在响应客户端前，此时会将源IP地址修改为自己的VIP地址，然后响应给客户端。 此时报文的源IP为VIP，目标IP为CIP

#### VS-NAT模式的特性

(1) RS应该和DIP应该使用私网地址，且RS的网关要指向DIP；

(2) 请求和响应报文都要经由director转发；极高负载的场景中，director可能会成为系统瓶颈；

(3) 支持端口映射；

(4) RS可以使用任意OS；

(5) RS的RIP和Director的DIP必须在同一IP网络；

缺陷：对Director Server压力会比较大，请求和响应都需经过director server

### LVS-DR

通过为请求报文重新封装一个MAC首部进行转发，源MAC是DIP所在的接口的MAC，目标MAC是某挑选出的RS的RIP所在接口的MAC地址；源IP/PORT，以及目标IP/PORT均保持不变；

![image-20210819225929708](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20210819225929708.png)

1. 当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP
2. PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链
3. IPVS比对数据包请求的服务是否为集群服务，若是，将请求报文中的源MAC地址修改为DIP的MAC地址，将目标MAC地址修改RIP的MAC地址，然后将数据包发至POSTROUTING链。 此时的源IP和目的IP均未修改，仅修改了源MAC地址为DIP的MAC地址，目标MAC地址为RIP的MAC地址
4. 由于DS和RS在同一个网络中，所以是通过二层来传输。POSTROUTING链检查目标MAC地址为RIP的MAC地址，那么此时数据包将会发至Real Server。
5. RS发现请求报文的MAC地址是自己的MAC地址，就接收此报文。处理完成之后，将响应报文通过lo接口传送给eth0网卡然后向外发出。 此时的源IP地址为VIP，目标IP为CIP
6. 响应报文最终送达至客户端

#### LVS-DR模式的特性

(1) 确保前端路由器将目标IP为VIP的请求报文发往Director：

​	(a) 在前端网关做静态绑定；

​	(b) 在RS上使用arptables；

​	(c) 在RS上修改内核参数以限制arp通告及应答级别；

​	修改RS上内核参数（arp_ignore和arp_announce）将RS上的VIP配置在lo接口的别名上，并限制其不能响应对VIP地址解析请求。

(2) RS的RIP可以使用私网地址，也可以是公网地址；RIP与DIP在同一IP网络；RIP的网关不能指向DIP，以确保响应报文不会经由Director；

(3) RS跟Director要在同一个物理网络；

(4) 请求报文要经由Director，但响应不能经由Director，而是由RS直接发往Client；

(5) 不支持端口映射；

缺陷：RS和DS必须在同一机房中

## LVS-Tun

![image-20210819230648323](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20210819230648323.png)

1. 当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP 。
2. PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链
3. IPVS比对数据包请求的服务是否为集群服务，若是，在请求报文的首部再次封装一层IP报文，封装源IP为为DIP，目标IP为RIP。然后发至POSTROUTING链。 此时源IP为DIP，目标IP为RIP
4. POSTROUTING链根据最新封装的IP报文，将数据包发至RS（因为在外层封装多了一层IP首部，所以可以理解为此时通过隧道传输）。 此时源IP为DIP，目标IP为RIP
5. RS接收到报文后发现是自己的IP地址，就将报文接收下来，拆除掉最外层的IP后，会发现里面还有一层IP首部，而且目标是自己的lo接口VIP，那么此时RS开始处理此请求，处理完成之后，通过lo接口送给eth0网卡，然后向外传递。 此时的源IP地址为VIP，目标IP为CIP
6. 响应报文最终送达至客户端

LVS-Tun模式的特性

(1) DIP, VIP, RIP都应该是公网地址；

(2) RS的网关不能，也不可能指向DIP；

(3) 请求报文要经由Director，但响应不能经由Director；

(4) 不支持端口映射；

(5) RS的OS得支持隧道功能；

# 应用层

## 网络应用模型
### C\S模型（客户/服务器式）

- 区分处理器请求的服务器和发出请求的客户机
- 有一个总是打开的主机称为服务器
	- 提供计算服务的设备
		- 永久提供服务
		- 永久性访问地址/域名
	- 服务器程序不需要知道客户程序的地址
	- 客户程序必须知道服务器程序的地址
- 各计算机地位不平等
- 整个网络管理工作由少数服务器承担，所以网络管理非常集中和方便
- 客户机之间不相互通信
- 客户机面向用户，服务器面向任务
- 客户机通常位与前端，服务器通常位于后端
- 客户端是请求方，连接建立后，**服务器能主动发送数据**
- 优点
    - 结构简单
	- 支持分布式、并发环境
	- 有效提高资源的利用率和共享程度
	- 服务器集中管理资源，有利于权限控制和系统安全
	- 可扩展性较好,客户和服务器均可单独地升级

### P2P模型（对等式）

- 每台机器既是服务器又是客户机
- P2P是网络结点之间采取对等方式直接交换信息的工作模式
- P2P通信模式是指P2P**网络中对等结点之间的直接通信能力**
- 不存在永远在线的服务器
- P2P**是动态的逻辑网络**
- 减轻了服务器的计算压力，消除了对某个服务器的依赖
- 多个客户机可以共享文档
- 可拓展性好
- 网络健壮性强
## 域名系统（DNS）
$$
域名组成：主机名. 结构名. 网络名. 最高层域名
$$
- DNS是一个基于客户/服务器模式的**分布式数据库系统**，主要作用是进行域名和IP地址之间的相互映射
- 通过查询获得主机和网络的相关信息
- DNS使用传输层UDP协议进行传输
- 映射(**非一一对应关系**)
    - 负载均衡
    
        - 多台主机映射到同一个域名上
    
    - 虚拟主机
    
        - 一台主机映射到多个域名上
    
    - 服务器双线接入
    
        - 一台主机通过两块网卡连接到两个网络，就具有两个IP地址，每个网卡对应一个MAC地址，显然这两个IP地址可以映射到同一个域名上
- 作用
    - 把用来便于人们记忆的具有特定含义的主机名转换为便于机器处理的IP地址
    - 通过查询获得主机和网络的相关信息
- 从概念上DNS可分为三个部分
    - 层次域名空间
    - 域名服务器
      
        - 主域名服务器运行域名服务器软件，有域名数据库
        - 辅助域名服务器运行域名服务器软件，有域名数据库
        - 一个域名**有且仅有**一个主域名服务器
    
    - 解析器
- 协议与端口
  
    - 运行在UDP之上，使用53号端口
- DNS层次结构
    - 根域名服务器
    - 顶级域名服务器
    
        - 国家顶级域名
        - 通用顶级域名
        - 基础结构域名
            - 这种顶级域名只有一个，即arpa，用于反向域名解析
    
    - 权限域名服务器
- 域名写法
    - 级别最低的写在最右边
    - 级别最高的写在最左边
    - 域名没有大小写之分
    - 标号中除字符(-)之外不能使用其他的标点符号
- 服务器分类
    - **根**域名服务器
        - 知道所有顶级域名服务器的IP地址
        
    - **顶级**域名服务器
        - 负责管理在其服务器注册的所有二级域名
        
    - **授权**域名服务器
        - **能够将其管辖的主机名转换为该主机的IP地址**
	    
	- **本地域名服务器**
        - 本地网络提供商负责的域名服务器
	    - 一个域名**有且仅有**一个主域名服务器
- 基于C/S模式的分布式系统
- 域名解析过程
    - 发出DNS查询报文时，**首先**被送往该主机的**本地域名服务器**
    - **递归查询**(总线型)
        - **主机向本地域名服务器的查询采用的是递归查询**
            - 本地域名服务器只需向根域名服务器服务查询一次，后面的几次查询都是递归地在其他几个域名服务器之间进行的
        
    - **迭代查询**(星型)
        - **本地域名服务器向根域名服务器的查询采用迭代查询**
        
            - 根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所要查询的IP地址，要么告诉本地域名服务器下一步应当向哪个顶级域名服务器进行查询，然后让本地域名服务器向这个顶级域名服务器进行后续的查询
- 在域名解析过程中，主机上请求域名解析的软件只需要知道本地域名服务器的IP
- 高速缓存
    - 提高DNS的查询效率，并减少因特网上的DNS查询报文数量
    - 主机名与IP地址之间的映射不是永久的，所以DNS服务器将在一段时间之后丢弃高速缓存中的信息
    - 在一次域名解析中，最少可以发出**0次DNS查询**(即高速缓存有所需要的域名DNS信息)
## 文件传输协议（FTP）
### 作用
- 允许用户在因特网上存取文件
- 允许客户指明文件的类型与格式，并允许文件具有存取权限
- **并不适合**用在两台计算机之间**共享文件**
- FTP控制信息**带外传送**
- 屏蔽了各计算机系统的细节，适合在**异构网络**中的任意计算机之间进行文件传输
    - 工作原理
        - 功能
            - 提供不同种类主机系统之间的文件传输能力
            - 以用户权限管理的方式提供用户对远程FTP服务器上的文件管理能力
            - 以匿名FTP的方式提供公用文件共享的能力
        - 采用客户/服务器的工作方式，使用TCP可靠传输服务
        - 组成
            - 主进程
                - 负责处理新的请求
            - 从属进程
                - 负责处理单个请求
- 匿名用户
    - FTP文件传输，系统管理员建立了一个特殊的用户ID，名为**anonymous**
- 协议与端口
    - 运行在**TCP**之上，控制链接为21号端口，数据链接为20号端口
	- 21号端口与20号端口是**服务器的端口**,不是客户端的端口
	    - TCP协议
		    - TCP控制连接端口
			    - 服务器端口TCP **21**
				    - 在整个会话期间过程中一直保持打开状态
			    - 传请求
			    - FTP的控制信息是外带传送的
		    - TCP数据连接端口
			    - 主动方式
				    - 服务器端口TCP **20**
			    - 被动方式
    			    - 服务器与客户自行协商决定TCP端口
                      
	                    - **FTP数据端口号=FTP控制端口号-1**
			    - 传文件
		    - **控制连接先于数据连接被建立，并晚于数据连接被释放**
		    - 这样可以使协议更加简单和更容易实现,同时在传输文件时利用控制连接
## 电子邮件
- 储存转发式
- SMTP邮件服务器和POP服务器只有在用户**输入正确的身份消息后**才允许对邮箱进行存取
- 基于万维网的电子邮件中,用户与电子邮件服务器使用的是**HTTP**协议,而不是SMTP协议;SMTP协议仅适用于电子邮件服务器之间
### 组成结构
- 用户代理
	- 电子邮件客户端软件
- 邮件服务器
    - 组成邮件系统的核心
    - 发送和接收邮件，同时向发信人报告邮件传送情况
- 电子邮件使用协议
    - **SMTP**
        - 采用“推”方式
        - **发送邮件**
    - **POP3、IMAP、HTTP**
        - 采用“拉”方式
        - **接收文件**
- 电子邮件收发过程
    - 发信人调用用户代理来撰写和编辑要发送的邮件，用户代理用SMTP把邮件传送给发送方邮件服务器
    - 发送方邮件服务器将邮件放入邮件缓存队列中，等待发送
    - 运行在发送方邮件服务器的SMTP客户进程，发现邮件缓存中有待发送的文件，就向运行在接收方邮件服务器的SMTP服务器进程发起建立TCP连接
    - TCP连接建立后，SMTP客户进程开始向远程SMTP服务器进程发送邮件。当所有待发送的邮件发完后，SMTP就关闭所建立的TCP连接
    - 运行在接收方邮件服务器的SMTP服务器进程收到邮件后，将邮件放入收信人的用户邮箱，等待收信人在方便时进行读取
    - 收信人打算收信时，吊椅调用用户代理，使用POP3协议将自己的邮件从接收方邮件服务器的用户邮箱中取回
### 电子邮件格式与MIME
- 电子邮件格式
	$$
  收件人邮箱名@邮箱所在主机域名
	$$
    - 分为信封和内容两大部分
    - 邮件内容的首部包含一些首部行，每个首部行由一个关键字后跟冒号再后跟值组成。有些关键字是必须的，有些则是可选的
    - 最重要的关键字是To:和Subject:
    - To是必须的关键字
      
        - **收件人邮箱名@邮箱所在主机的域名**，收信人邮箱名即用户名，在邮件服务器上必须是唯一的
    
    - Subject是可选关键字，是邮件的主题，反映了邮箱的主要内容
    - From通常用邮件系统自动填入，首部与主体之间用一个空行进行分割

- 多用途网际邮箱扩充MIME
    - MIME意图是继续使用目前的格式，但增加了邮件主体的结构，并定义了传送**非ASCII码的编码规则**
    - MIME可在现有的电子邮件程序和协议下传送
    - MIME可以将非ASCII码内容表示成ASCII码内容
    
        - **base64**编码方式
        
            - 不管是否是ASCII码字符，**每3个字符用另4个ASCII码字符表示**
            $$
            \frac{3}{4}=\frac{待编码字长}{编码后字长}
            $$
            
        - **quoted-printable**编码方式
        
            - ASCII码字符保持不变，非ASCII码字符用=XX表示，其中XX是该字符的十六进制值
    
    - MIME主要包含以下三部分内容
      
        - 5个新的邮件首部字段
          
            - MIME版本
            - 内容描述
            - 内容标识
            - 内容传送编码
            - 内容类型
        
        - 定义了许多邮件内容的格式，对多媒体电子邮件的表示方法进行了标准化
        - 定义了传送编码，可对任何内容格式进行转换，而不会被邮件系统改变
### STMP（发）
- 作用
	- 向邮件服务器主动发送电子邮件
	- **在不同的邮件服务器之间传送邮件才使用STMP**
	- 无需转换就可以由SMTP直接传输的内容是ASCII文本
- 过程
	- **连接建立**
		- 220 Service ready(服务就绪)
            - 220 <**邮件接收方**> simple meil transfer service ready
			- 250 OK
			- 421 Service not available
        - HELO命令
            - HELO <**邮件接收方**>
        - SMTP**不使用中间邮件服务器**，TCP连接总是在发送方和接收方这两个邮件服务器之间直接建立，而不管他们相隔多远
	- **邮件传送**
        - 250 OK
        - 550 No such user here(无此用户)
	- **连接释放**
		- SMTP客户发送QUIT命令
			- 返回221，表示同意释放TCP连接
- 协议与端口
	
	- 运行在**TCP**之上，**使用25号端口**
- SMTP不能传送可执行文件或者其他二进制对象，基于ASCII码，**仅能发送7比特ASCII码的数据**
- SMTP服务器会拒绝超过一定长度的邮件
	
	- 通用因特网邮件扩充MIME
### POP3（收）
- 作用
	- 向邮件服务器要求接收电子邮件
- 工作方式
	- 下载并保留（在服务器）
	- 下载并删除
	- 基于ASCII码，**仅能接收ASCII码的数据**
- 协议与端口
	- 运行在**TCP**之上，使用**110**号端口
- 网际报文存取协议IMAP
- 使用**明文**来**发送密码**
### 基于万维网的电子邮件
- HTTP协议
## 万维网（WWW）
- 万维网是一个资料空间，在这个空间中：一样有用的事物称为一样“资源”，并由一个全域“统一资源定位符”标识，这些资源通过超文本传输协议传送给使用者，而后者通过单击链接来获取资源
- 应用层提供的一种**服务**
- 能够**接受请求并发送网页**的计算机叫WWW服务器
- 大规模的/联机式的信息贮藏所
- 基于**C/S**模式
### 搜索引擎
* 全文检索搜索引擎
    * 百度
    * 谷歌
* 分类目录搜索引擎
    * 搜狐
* 垂直搜索引擎
### 统一资源定位符(URL)
- 负责标识万维网上各种文档，使每个文档在整个万维网的范围内具有**唯一的标识符URL**
- **URL不区分大小写**
- URL一般格式
$$
<协议>://<主机>:<端口>/<路径>
$$
- <**协议**>常用的有http、ftp等
- <**主机**>是存放资源的主机在因特网中的域名，也可以是IP地址
- <**端口**>和<**路径**>有时可以省略
- 组成
    - **协议**
    - **主机地址（域名）**
    - **文件路径名**
### 超文本传输协议（HTTP）
- 作用
	- 在万维网上能够可靠地交换文件
	- 规定**浏览器**与**万维网服务器**互相通信的规则，通过因特网传输万维网文档的数据传送协议
- 协议与端口
	
	- 运行在**TCP**之上，**使用80号端口**
- 特点
	- 无状态
	- **Cookie**是存储在用户主机中的文本文件，记录一段时间内某用户的访问记录
        - **如果有Cookie，证明曾经浏览过该网站**
	- **HTTP协议本身是无连接的,但是在传输层采用TCP,是面向连接的**
	- 面向事务的应用层协议
	- **面向文本**
- HTTP下请求网页的时间
    - **请求一个万维网文档的时间是该文档的传输时间加上两倍往返时间RTT**
    - 一个RTT用于**TCP连接**,另一个RTT用于**请求和接收万维网文档**
- 连接方式
  - 非持久连接
        - HTTP 1.0
            - Connection:Close
            - 建立连接消耗2RTT时间
                 - 非并行读取每一个对象花费2RTT时间
                 - 并行读取所有图像共花费2RTT时间
    
    - 持久连接
         - HTTP 1.1
              - Connection:keep-alive
              - 在持续连接方式下,不管传输多少数据,只需建立一次TCP连接,消耗2RTT时间
              - 两种工作方式
              	- 流水线方式
                  - <u>*所有对象都只花费一个RTT的时间*</u>(所有)
                 - 非流水线方式
           - <u>*每访问一次对象都要用去一个往返时间RTT*</u>(单个)
                         - 无捎带HTTP请求
- HTTP报文
	- 请求报文
	    - 从客户向服务器发送的请求报文
      
    - 响应报文
      
        - 从服务器到客户的回答
- 网页是用HTML语言写成的文件，**网页文件通常以.html为扩展名**

方法 | 意义
---|---
GET | 请求读取由URL标识的信息
HEAD| 请求读取由URL标识的信息的首部
POST| 给服务器添加信息
CONNECT| 用于代理服务器 

- 报文结构
    - 开始行
      
        - CR表示回车
        - LF表示换行
    
    - 首部行
    - 实体主体
- 过程
    - 建立连接
    - 发出请求信息
    - 回送响应信息
    - 关闭连接
#### 万维网的文档
##### 静态文档
- 在文档创作完毕后就存放在万维网服务器中,在被用户浏览的过程中内容**不会改变**
- 优点简单,缺点不够灵活
##### 动态文档
- 在浏览器**访问万维网服务器时才由应用程序动态创建**
- 要求动态文档的开发人员必须会编程,而所编写的程序还要通过大范围的测试,以保证输入的有效性

##### 活动文档

- 把所有工作都转移给**浏览器端**,每当浏览器请求一个活动文档时,服务器就返回一段活动文档程序副本,使该程序副本在浏览器端运行
### 超文本标记语言(HTML)
- 超文本文档通过指针连接在一起
- 文档结构标记语言，使用约定的标记对页面上的各种信息进行描述
### SNMP(简单网络管理协议)
#### 基本原理
- <u>***对硬件、软件和人力的使用、综合与协调，以便对网络资源进行监视、测试、配置和分析，满足网络的需求***</u>
#### 被管对象的特性

*    值与类型
*    简单类型和结构化类型

#### 组成
- 采用**UDP**的应用层协议
- SNMP本身
    - 定义了管理站和代理之间所交换的分组格式
- 管理信息结构SMI
    - 定义了命名对象和定义对象类型的通用规则,以及把对象和对象的值进行编码的规则BER
- 管理信息库MIB
    - 在被管理的实体中创建了命名对象,并规定其类型
# 网络安全
## 防火墙
- 防火墙是网络连接,限制外部网络对内部网络的非法访问或内部网络对外部网络的保护计算机网络安全的一种技术措施
- 它利用一个或一组网络设备,在内部网和外部网之间构造一个保护层障碍,用来检测所有的内、外非法访问,并保障系统本身不受信息穿越的影响
- **在Internet与Intranet之间**,由防火墙负责对网络服务请求的合法性进行检查
## 网络安全面临的问题
- 系统漏洞
- 黑客攻击
- 病毒入侵
- 网络配置管理不当
## 被动攻击
- 攻击者从网络上**窃听**他人的通信内容.通常把这类攻击称为**截获**
- 被动攻击中,攻击者只是观察和分析某一个协议数据单元PDU而不干扰信息流.即使这些数据对攻击者来说是不易理解的,也可通过观察PDU的协议控制信息部分,了解正在通信的协议实体的地址和身份,研究PDU的长度和传输的频度,以便了解所交换的数据的某种性质
- **不影响网络正常通信**
## 主动攻击
- 中断
- 篡改
  
    - 攻击者故意篡改网络上传送的报文,也被称作"更改报文流"
    
- 恶意程序
  
    - 计算机病毒
      
        - 一种会"传染"其他程序的程序,是通过修改其他程序来把自身或其变种复制进去完成的
        
    - 计算机蠕虫
      
        - 一种通过网络的通信功能将自身从一个结点发送到另一个结点并自动启动运行的程序
        
    - 特洛伊木马
      
        - 一种程序,执行的功能并非所声称的功能而是某种恶意的功能
        
    - 逻辑炸弹
      
        - 一种当运行环境满足某种特定条件时执行其他特殊功能的程序
    
- 拒绝服务
  
    - 拒绝服务DoS(Denial of Service)
    - 分布式拒绝服务DDoS(Distributed Denial of Service)
## 密码体制
- 对称密钥密码体制
  
    - 加密密钥与解密密钥是**相同**的密码体制
    - **数据加密标准DES**属于对称密钥密码体制,保密性仅取决于对密钥的保密,而算法是公开的。DES使用**56位密钥**对64位的数据块进行加密，并对64位的数据块进行16轮编码。
    - **DES不能用于数字签名**
    
- 公钥密码体制
  
    - 使用**不同**的加密密钥与解密密钥
    - **RSA**使用公钥密码体制
    - 加密密钥PK(public key)向公众开放,而解密密钥SK(secret key)则是需要保密的
    
- 任何加密方法的安全性取决于密钥的长度,以及攻破密文所需的计算量,而不是简单取决于加密的体制
## 数字签名
- 使用**数字信封**可以同时实现身份认证和保证所发送数据的机密性
- 功能
  
    - 报文鉴别
      - 接受者能够核实发送者对报文的签名
      
    - 报文的完整性
      - 接受者确信所收到的数据和发送者发送的数据完全一样而没有被篡改过
      
    - 不可否认
      - 发送者事后不能抵赖对报文的签名

# 英文缩写词

英文缩写|英文全称|简单解释
:-:|:-:|:-:
**ADSL**|**Asymmetric Digital Subscriber Line**|**非对称数字用户线**
ARP|Address Resolution Protocol|地址解析协议
ACK|ACKnowledegment|确认
ARQ|Automatic Repeat reQuest|自动重传请求
AS|Autonomous System|自治系统
BGP|Border Gateway Protocol|边界网关协议
CA|Collision Avoidance|碰撞避免
CDM|Code Division Multyiplexing|码分复用
CDMA|Code Division Multiplex Access|码分多址
**CGI**|**Common Gateway Interface**|**通用网关接口**
CIDR|Classless InterDomain Routing|无分类域间路由选择
CRC|Cyclic Redundancy Check|循环冗余检验
DF|Don't Fragment|不能分片
**DHCP**|**Dynamic Host Configuration Protocal**|**动态主机配置协议**
DiffServ|Differentiated Services|区分服务
DNS|Domain Names System|域名系统
DOS|Denial of Service|拒绝服务
**DES**|**Data Encryption Standard**|**数据加密标准**
**DDoS**|**Distributed Denial of Service**|**分布式拒绝服务**
EGP|External Gateway Protocol|外部网关协议
**ESP**|**Encapsulating Security Payload**|**封装安全有效载荷**
ESS|Extended Service Set|扩展服务集
FCS|Frame Check Squence|帧检验序列
FDDI|Fiber Distributed Data Interface|光纤分布式数据接口
FDM|Frequency Division Multiplexing|频分复用
FIFO|First In First Out|先进先出
FQ|Fair Queuing|公平排队
FTP|File Transfer Protocol|文件传输协议
HDLC|High-level Data Link Control|高级数据链路控制
HDSL|High speed DSL|高速数字用户线
**HTML**|**HyperText Markup Language**|**超文本标记语言**
**HTTP**|**HyperText Transfer Protocol**|**超文本传送协议**
ICMP| Internet Control Message Protocol |网际控制报文协议       
IGMP|Internet Group Management Protocol|网际组管理协议
**IP**|**Internet Protocol**|**网际协议**
ISO|International Organization for Standardization|国际标准化组织
**ISP**|**Internet Service Provider**|**因特网服务提供者**
LAN|Local Area Network|局域网
LCP|Link Control Protocol|链路控制协议
LSR|Label Switching Router|标记交换路由器
LLC|Logical Link Control|逻辑链路控制
MF|More Fragment|还有分片
MIME|Multipurpose Internet Mail Extensions|通用因特网邮件扩充
MTU|Maximum Transfer Unit|最大传送单元
**MAC**|**Media Access Control**|**媒体接入控制**
NAT|Network Address Translation|网络地址转换
NCP|Network Control Protocol|网络控制协议
NIC|Network Interface Card|网卡
**OSPF**|**Open Shortest Path First**|**开放最短通路优先**
P2P|Peer-to-Peer|对等方式
PDU|Protocol Data Unit|协议数据单元
**PON**|**Passive Optical Network**|**无源光网络**
**PAP**|**Password Authentication Protocol**|**口令鉴别协议**
PPP|Point-to-Point Protocol|点对点协议
PPPoE|Point-to-Point Protocol over Ethernet|以太网上的点对点协议
**QoS**|**Quality of Service**|**服务质量**
RIP|Routing Information Protocol|路由信息协议
RTS|Request To Sent|请求发送
RTT|Round-Trip Time|往返时间
POP|Post Office Protocol|邮局协议
SMTP|Simple Mail Transfer Protocol|简单邮件传送协议
**SNMP**|**Simple Network Management Protocol**|**简单网络管理协议**
SAP|Service Access Point|服务访问点
TLD|Top Level Domain|顶级域名
**TCP**|**Transmission Control Potocol**|**传输控制协议**
**UDP**|**User Datagram Protocol**|**用户数据报协议**
**URL**|**Uniform Resource Locator**|**统一资源定位符**
VLAN|Virtual LAN|虚拟局域网
**VPN**|**Virual Private Network**|**虚拟专用网**
**WAN**|**Wide Area Network**|**广域网**
WWW|World Wide Web|万维网
XML|Extensible Markup Language|可扩展标记语言
重要的一点

# 协议总结

<table>
	<tr>
	    <th>网络体系层数</th>
	    <th>协议</th>
	    <th>描述</th>
	    <th>全称</th>
	    <th>特征</th>
	</tr >
	<tr >
	    <td rowspan="2">数据链路层</td>
	    <td>HDLC</td>
	    <td>High-level Data Link Control</td>
	    <td>高级数据链路控制协议</td>
	    <td>零比特填充<br></td>
	</tr>
	<tr>
	    <td>PPP</td>
	    <td>Point-to-Point Protocol</td>
	    <td>点对点协议</td>
	    <td>字节填充<br>
	    链路控制协议LCP<br>
        网络控制协议NCP</td>
	</tr>
	<tr>
	    <td rowspan="6">网络层</td>
	    <td>IP</td>
	    <td>Internet Protocol</td>
	    <td>网际协议</td>
	    <td>首部长度20B<br>
	    IP数据报</td>
	</tr>
	<tr>
	    <td>ICMP</td>
	    <td>Internet Control Message Protocol</td>
	    <td>网际控制报文</td>
        <td>差错报文<br>
        &emsp;终点不可达<br>
        &emsp;源点抑制<br>
        &emsp;时间超过<br>
        &emsp;参数问题<br>
        &emsp;改变路由<br>
        询问报文PING</td>
	</tr>
	<tr>
	    <td>ARP</td>
	    <td>Address Resolution Protocol</td>
	    <td>地址解析协议</td>
	    <td>找相应IP地址的硬件地址<br>
	    ARP高速缓存</td>
	</tr>
	<tr>
	    <td>OSPF</td>
	    <td>Open Shortest Path First</td>
	    <td>开放最短通路优先</td>
	    <td>向本自治系统内所有路由器发送信息(洪泛法)<br>
	    链路状态算法</td>
	</tr>
	<tr>
	    <td>RARP</td>
	    <td>Reverse Address Resolution Protocol</td>
	    <td>逆地址解析协议</td>
	    <td>使知道硬件地址找出相应IP地址</td>
	</tr>
	<tr>
	    <td>IGMP</td>
	    <td>Internet Group Management Protocol</td>
	    <td>网际组管理协议</td>
	    <td>组播地址为D类地址</td>
	</tr>
	<tr>
	    <td rowspan="2">传输层</td>
	    <td>UDP</td>
	    <td>User Datagram Protocol</td>
	    <td>用户数据报协议</td>
	    <td>无连接(数据报)<br>
	    首部长度8B<br>
	    报文为单位</td>
	</tr>
	<tr>
	    <td >TCP</td>
	    <td>Transmission Control Protocol</td>
	    <td>传输控制协议</td>
	    <td>有连接(虚电路)<br>
	    首部长度20B<br>
	    字节流为单位</td>
	</tr>
	<tr>
	    <td rowspan="7">应用层</td>
	    <td >FTP</td>
	    <td >File Transfer Protocol</td>
	    <td>文件传送协议<br></td>
	    <td>使用TCP</td>
	</tr>
	<tr>
	    <td>TFTP</td>
	    <td>Trivial File Transfer Protocol</td>
	    <td>简单文件传送协议</td>
	    <td>使用UDP</td>
	<tr>
	    <td >DNS</td>
	    <td >Domain Name System</td>
	    <td >域名系统</td>
        <td>根域名服务器<br>
        顶级域名服务器<br>
        授权域名服务器(转换)<br>
        本地域名服务器<br>
        使用UDP</td>
	</tr>
	<tr>
	    <td >SMTP</td>
	    <td >Simple Mail Transfer Protocol</td>
	    <td >简单邮件传送协议</td>
	    <td>发送邮件<br>使用TCP</td>
	</tr>
	<tr>
	    <td >POP3</td>
	    <td >Post Office Protocol</td>
	    <td >邮局协议</td>
	    <td >收邮件<br>使用TCP</td >
	</tr>
	<tr>
	    <td >HTTP</td>
	    <td >HyperText Transfer Protocol</td>
	    <td >超文本传送协议</td>
	    <td >网页<br>使用TCP</td >
	</tr>
	<tr>
	    <td>RIP</td>
	    <td>Routing Information Protocol</td>
	    <td>路由信息协议</td>
	    <td>使用TCP<br>
	    距离-向量路径算法</td>
	</tr>
</table>
---
<table>
    <tr>
        <td></td>
        <td>设备</td>
        <td>冲突域</td>
        <td>广播域</td>
    </tr>
    <tr>
        <td rowspan="2">物理层设备</td>
        <td>中继器</td>
        <td>不隔离</td>
        <td>不隔离</td>
    </tr>
    <tr>
        <td>集线器</td>
        <td>不隔离</td>
        <td>不隔离</td>
    </tr>
    <tr>
        <td rowspan="2">数据传输层设备</td>
        <td>网桥</td>
        <td>隔离</td>
        <td>不隔离</td>
    </tr>
    <tr>
        <td>交换机</td>
        <td>隔离</td>
        <td>不隔离</td>
    </tr>
    <tr>
        <td>网络层设备</td>
        <td>路由器</td>
        <td>隔离</td>
        <td>隔离</td>
    </tr>
</table>
---
<table>
    <tr>
        <td>对象</td>
        <td>数值</td>
    </tr>
    <tr>
        <td>IP首部</td>
        <td>20B</td>
    </tr>
    <tr>
        <td>IP首部长度单位</td>
        <td>4B</td>
    </tr>
    <tr>
        <td>IP总长度单位</td>
        <td>1B</td>
    </tr>
    <tr>
        <td>IP片偏移长度</td>
        <td>8B</td>
    </tr>
    <tr>
        <td>TCP首部长度</td>
        <td>20B</td>
    </tr>
    <tr>
        <td>TCP数据部分最多</td>
        <td>65495B</td>
    </tr>
    <tr>
        <td>数据帧最小长度</td>
        <td>64B</td>
    </tr>
    <tr>
        <td>UDP首部长度</td>
        <td>8B</td>
    </tr>
    <tr>
        <td>IP地址</td>
        <td>4B=32bit</td>
    </tr>
    <tr>
        <td>硬件地址</td>
        <td>6B=48bit</td>
    </tr>
    <tr>
        <td>以太网最短帧长</td>
        <td>64B</td>
    </tr>
    <tr>
        <td>端口号</td>
        <td>2B</td>
    </tr>
    <tr>
        <td>IPv6地址</td>
        <td>16B=128bit</td>
    </tr>
    <tr>
        <td>IP分组最大长度</td>
        <td>65535B</td>
    </tr>
</table>


---
<table>
    <tr>
        <td>RIP</td>
        <td>应用层</td>
        <td>IGP</td>
        <td>距离-向量算法</td>
        <td>UDP</td>
    </tr>
    <tr>
        <td>OSPF</td>
        <td>网络层</td>
        <td>IGP</td>
        <td>链路状态算法</td>
        <td>IP</td>
    </tr>
    <tr>
        <td>BGP</td>
        <td>应用层</td>
        <td>EGP</td>
        <td>路径-向量算法</td>
        <td>TCP</td>
    <tr>
</table>

---

计算机网络层|单位|协议
:-:|:-:|:-:
应用层|数据|DNS、FTP、TFTP、SMTP、POP3、RIP、BGP、HTTP、DHCP、SNMP
表示层||
会话层||
传输层|报文|UDP、TCP
网络层|分组|IP、ICMP、ARP、RARP
数据链路层|MAC帧|PPP、HDLC(不属于TCP/IP体系)
物理层|比特流|

# 抓包

## 获取连接

```
ifconfig
```

## 获取网络状态

* 获取socket

```
netstat -natp
```

* Proto显示连接使用的协议
* RefCnt表示连接到本套接口上的进程数量
* Types显示套接口的类型
* State显示套接口当前的状态
* Path表示连接到套接口的其它进程使用的路径名

## 抓包

```
tcpdump -nn -i <网卡名>
```

抓端口号为<端口号>的数据包

```
tcpdump -nn -i <网卡名> port <端口号>
```

## 创建连接

* 连接是Linux文件

```
exec 8<> /dev/tcp/www.baidu.com/80
```

## 查看连接

```
echo -e "GET / HTTP/1.0\n" >& 8
```

```
cat <&8
```

## 关闭连接

```
exec 8>& -
```

## 查找路由表

```
route -n
```

| Destination | 目标可达 |
| ----------- | -------- |
| Gateway     | 网关     |
| Genmask     | 掩码     |
| Flags       |          |
| Metric      |          |
| Ref         |          |
| Use         |          |
| Iface*      | 接口     |

* Genmask=0.0.0.0，Destination=0.0.0.0，外网都能匹配上
* 网址与掩码相与,得到网络地址

## 检测连通性

```
ping <地址>
```

## 获得MAC地址（ARP）

```
arp -an
```

# 802.11协议

## 学习资料

### **综合类**

**1.CWNP系列教材**

CWNP（[CWNP](https://link.zhihu.com/?target=https%3A//www.cwnp.com/)）是一个无线方向的认证项目，其教材是比较适合初学802.11协议的人使用的，其主要是避免了大量的数学工程，基本是从工程师应用的角度来编写。按照其官网所描述，CWNP的认证包含：CWTS，CWNA，CWSP，CWDP，CWAP，CWNE，CWNT。其中CWNA的教材最为适合初学，且也有中文的翻译版。其余CWSP，CWDP等教材适合进阶一步阅读。部分的教材（包含了CWTS，CWNA，CWSP，CWDP，CWAP）可以在【[Download Wireless Networking Study Guides](https://link.zhihu.com/?target=http%3A//srijit.com/download-wireless-networking-study-guides/)】该链接下载，我也打包了一份【[CWNP系列教材（整合版）](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477045)】。

**2.802.11权威指南（O'Reilly）**

802.11权威指南是早期的一本802.11的专著，与协议的贴合度很高（个人感觉更接近于2007版本的802.11协议），不过缺点在于对于一些当前最新的802.11协议缺乏描述，毕竟该书的初版的时候，802.11n还是处于草案阶段。整体而言，整本书的内容还是比较丰富的，而且也包含了很多细节的部分（如物理层细节），同时也避免了很多公式推导。目前收集到《802.11权威指南》的资源如下，【[802.11权威指南](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9426208)】。

**3.802.11 Survival Guide（O'Reilly）**

由于802.11权威指南中没有专门讨论过802.11n和802.11ac，所以后面O'Reilly还有两本书专门说明有关802.11n和802.11ac的内容，包含：802.11n A Survival Guide与802.11ac A Survival Guide。粗读一遍，感觉协议的很多部分（包含物理层和MAC层）还是描述的很详细的，其相应的资源整理如下，【[802.11 Survival Guide（OReilly)](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477087)】。

**4.Next Generation Wireless LANs（Cambridge）**

Cambridge的两本有关802.11的专著：Cambridge.Next Generation Wireless LANs.802.11n与Cambridge.Next Generation Wireless LANs.802.11n and 802.11ac，感觉是两本描述802.11的书籍中最为细致的两本书，也同时感觉最为权威的两本书，其中很多物理层细节与MAC层细节都只有在这本书中可以找到（尤其是802.11的物理层部分）。如果打算详细研究802.11协议的话，非常建议读下这本书，其中后者是新版（包含了802.11n和802.11ac的主要内容），所以更加推荐阅读。其相应的资源整理如下，【[Next Generation Wireless LANs (Cambridge)](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477083)】。

其实有关Cambridge.Next Generation Wireless LANs.802.11n，该书国内也存在翻译版，其资源整理如下，【[下一代无线局域网：802.11n的吞吐率、强健性和可靠性](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9502196)】。

**5.WAPI协议**

WAPI和802.11的关系有兴趣可以自行搜索。从学习的角度上而言，WAPI可以当做中文的802.11（即802.11的早期版本）。比较适合早期阅读802.11协议原版，毕竟原协议内容，写法之类都和一般书本不同，所以还是中文的资料好适应一些。其相应的资源整理如下，【[WAPI](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477102)】。

**6.802.11协议（2007版与2012版）**

802.11协议有很多个版本，包含了众所周知的是802.11a/b/g/n/ac这些，其余还有802.11r/802.11k/802.11s等等很多协议版本，以及还存在协议的演化，比如802.11ae/802.11aa这些。其中802.11的2007版和2012版算是一个协议整合版，其中802.11-2012版包含了07版以及802.11n，802.11k，802.11r等相应的内容，所以适合详细阅读802.11协议使用，不过2012版中没有包含802.11ac/ad，802.11ah，802.11ae，802.11aa等相关的内容，所以这些新协议还需要读协议的分支。其中07版和12版的相应资源整理如下，【[IEEE 802.11 2007/2012](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477127)】。

### **安全类**

**1.802.11 security（O'Reilly）**

O'Reilly也有一本关于802.11安全的专著，这本书目前还没有读完，整体感觉还是比较好的。相应资源如下，【[802.11 security（OReilly）](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9730041)】。

**2.Real 802.11 Security - Wi-Fi Protected Access and 802.11i**

这本书老早之前读过一次，总体感觉还是可以的，该书主要讨论的是802.11i的内容，不过由于出版的较早，所以有些内容有些老了。相应的资源如下，【[Real 802.11 Security - Wi-Fi Protected Access and 802.11i](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477151)】。

### **设计类**

**1.IEEE 802.11 Tutorial（Berkeley）**

这份材料是bekerly那里出的较早期的IEEE 802.11 Tutorial，实际应该放在综合类中的。不过这份资料中的很多流程图描绘的还不错，是从整个协议执行的机制上所述，且都做了一定的简化，所以也是不错的材料。相应的资源如下，【[IEEE 802.11 Tutorial (Berkeley)](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477194)】。

**2.Wi-Fi：802.11 物理层和发射机测量概述**

这份资料是泰克公司公开的资料，实际上是将802.11物理层部分加以总结出的一份文档，用来快速学习802.11物理层的有关知识是很适合的，而且其中的内容也是从测试厂家的角度而写，相比一般书本的知识，这些内容更加偏实际一些。相应的资源如下，【[Wi-Fi：802.11物理层和发射机测量概述](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477192)】。

**3.802.11物理层规范海报**

这一份泰克这份海报，非常贴切802.11协议，其中很多物理层的内容，以及信道分配，5G可用信道有哪些，都有总结，作为速查非常方便。相应的资源如下，【[802.11物理层规范海报](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9669829)】

**4.通信新读**

实际上这份资料与802.11的关系不是很大，但是该书是一本的用来学习通信知识不错的书。适合初学者学习通信的理论知识，与大话系列不同，这本书还是很注重理论知识的。该书没有完整的电子版，只收集到试读的部分（笔者不少资料还是读的纸质版），相应的资源如下，【[通信新读（试读）](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477254)】。

**5.OFDM for wireless communications systems**

这本书是一份OFDM的专题书，且内容较短且精，适合作为了解OFDM基本原理后，不断重新深入理解OFDM原理所阅读，其中有些细节还是比较不错的。相应的资源如下，【[OFDM for wireless communications systems](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9668319)】。

**6.Radio Frequency Propagation Made Easy**

802.11中的信道模型实际上描述的内容并不多，故需要一些有关射频传播模型的背景知识才好深入理解一些，上面这份教材讲的深浅适中，对于理解802.11协议中的内容是足够的了。相应的资源如下，【[Radio Frequency Propagation Made Easy](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9614718)】

### **仿真类**

**1.MIMO-OFDM Wireless Communications with MATLAB**

该书是一篇有关MIMO-OFDM理论以及仿真的综合书，书中夹杂描述了一些802.11情况下的信道模型，物理层模型之类，由于当前802.11的主流技术是基于MIMO-OFDM的，且如果需要真正学习802.11相应的通信知识，还是多接触些物理层和数学为好，该书的理论都有配以仿真，所以很适合学习。相应的资源，包含原书和源码如下，【[MIMO-OFDM Wireless Communications with MATLAB](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477191)】。

**2.NS2仿真实验-多媒体与无线网络**

柯志恒老师的书，很多学习NS2的人一开始都学习过，这里收集了下书的电子版以及源码，相应的资源如下，【[NS2仿真实验-多媒体与无线网络 ](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477217)】。

**3.The NS2 Manual**

有关NS2的资料实际上是非常多的，笔者曾经用过一段时间NS2做802.11仿真，当时顺着这份材料学习了下，所以记录下。NS2有关802.11的资料还是非常多的，每个人可以根据自己的需求寻找资料。该资源如下，【[The NS2 Manual](https://link.zhihu.com/?target=http%3A//info.iet.unipi.it/~cicconetti/aan/download/everything.pdf)】。

**4.Implementation of IEEE 802.11 Physical Layer Model in NS3**

这份材料的原题目比较长（Study and Implementation of IEEE 802.11 Physical Layer Model in YANS (Future NS-3) Network Simulator），主要是讨论如何在NS3中模拟802.11物理层的模型。该资料中，提供了很多不同种类的物理层模型，以及参数，由于笔者在做仿真的时候，需要采用一些跨层仿真的方法，从这份资料里面算是得到不少启发，故记录一下。该资料相应的资源如下，【[Implementation of IEEE 802.11 Physical Layer Model in NS3](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477260)】。

### **实现类**

**1.深入理解Android：WiFi模块 NFC和GPS卷**

这本书是朋友推荐的一本书，当时是为了学习802.11安全协议的部分。由于直接从openwrt的角度来分析802.11源码的书很少，所以这本从andriod的角度分析源码的书也是挺好的，相应的资源如下，【[深入理解Android：WiFi模块 NFC和GPS卷](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477230)】。

**2.基于XILINX FPGA的OFDM通信系统基带设计**

该书是比较完整的叙述了802.11a的基带在FPGA上实现的书，虽然调源码的时候发现可能会发现有一些错误，但是总体上而言，这本书的知识结构也是较为完整的，笔者对于802.11在FPGA实现的英语材料没有怎么阅读过，故从这本书上也算获取了不少知识，总体感觉也是不错的。该书以及其源码的资源如下，【[基于XILINX FPGA的OFDM通信系统基带设计](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9477222)】。

**3.Linux Kernel Networking**

该书主要是描述了Linux内核中网络的实现部分，其第12章具体就是对应无线模块。由于描述Linux内核中无线模块资料比较少，所以这本书也是比较推荐的，只不过对于细节部分，该书描述不是特别细致，不过总体还是不错的。该书以及其源码的资源如下，【[Linux Kernel Networking ](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9578509)】。

**4.Linux Wi-Fi open source drivers-mac 802.11**

该材料比较完整的叙述了从kernel到802.11驱动底层的一个函数调用过程，用来学习802.11具体驱动过程是一份比较好的材料。该资料的资源如下，【[Linux Wi-Fi open source drivers-mac 802.11](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9712191)】。

**5.通信IC设计**

这份本书内容感觉目前是除了MATLAB 2016a/b代码以外，对802.11物理层最为详尽描述的材料了（在该书下册）。该书也有附带的相应代码。该书目前只有纸质版，有可以自行阅读。

### **历史类**

**1. The Innovation Journey of Wi-Fi (The Road to Global Success)**

这一份是描述802.11协议诞生以来到被广泛推广这一段时间以来的大致发展历史，其第二作者Vic Hayes在1990-2000年期间作为IEEE 802.11的主席，对这一块历史了解应该是非常深入的。该资料的资源如下，【[The Innovation Journey of Wi-Fi (The Road to Global Success)](https://link.zhihu.com/?target=http%3A//download.csdn.net/detail/fzxy002763/9752224)】

## DCF与CSMA/CA

### 序言

在初始802.11的MAC层中，分成了两种基本工作模式：

- DCF（Distributed Coordination Function）
- PCF（Point Coordination Function）

其中，由于DCF具有良好的分布式特性，从而应用更加广泛，而PCF模式则较为少用。在802.11e协议中，DCF被扩展为EDCA模式，PCF模式被扩展为HCCA模式。本文所讨论的主要内容即有关DCF模式以及其核心CSMA/CA机制。

*PS：在当前的802.11协议中，除了初始定义的DCF和PCF工作模式外，在802.11e中还定义了EDCA，HCCA，不过本文暂不展开。*

### **CSMA/CA机制**

由于无线信道只有一个冲突域的特性，所以需要设置一种随机接入机制，以避免多个节点同时访问网络所带来的冲突问题，在WiFi协议中，该随机接入机制即是CSMA/CA。CSMA/CA的全称是Carrier Sense Multiple Access with Collision Avoidance，即载波侦听多路访问／冲突避免。如果熟悉有线网络的可以知道，在集线器与中继器中也会采用一种CSMA/CD的机制，从协议设计的大思路上，两者是类似的，或者说两个都是基于CSMA机制的，而细节上，两者有很多的出入，在本文中，我们尚不细致讨论两者协议的具体差别，而仅仅叙述CSMA/CA的工作机制。

为了方便文中讨论，我们首先假定一个网络拓扑环境如下：



![img](https://pic4.zhimg.com/80/ed2e0d4d2791107140999bb15f800e63_720w.png)

在该拓扑中，存在一个AP，与两个节点（STA 1与STA 2），如果对于无线术语不是很熟悉的话，可以把AP理解成无线路由器。由于无线环境下的广播特性，`若STA 1与STA 2同时向AP发送数据，那么就会在AP处发生冲突，从而两者都无法正确接收，最终传输失败。CSMA/CA就是提供一种避免冲突发生的接入规则。`

接下来我们需要具体描述CSMA/CA的工作机制，为了方便理解，我们这里首先要给出四个概念：

- DIFS与SIFS：该两种都是属于Inter-frame Spacing（IFS），即帧间间隙。DIFS全称为Distributed Inter-frame Spacing，即分布式帧间间隙，SIFS称为Short inter-frame space，即短帧间间隔。在CSMA/CA中，发一个帧之前，都需要 **"等待"** 一个相应的帧间间隔，比如`发送数据之前`至少要等待DIFS时间，`发送ACK之前`需要等待SIFS时间。在802.11中还存在其他的一些帧间间隔，比如RIFS，PIFS，AIFS，EIFS，本文不再一一赘述。（注：该段落中所提到的等待，不是真正意义上节点什么都不做，具体的功能会在后文相应位置进行描述）
- Slot Time：时隙是指的一个时间片段，在CSMA/CA中，节点竞争接入信道之前需要经过相应的随机回退（backoff）过程，其中backoff过程就是由很多个时隙所组成的。
- Contention window：竞争窗口是用来让节点选择随机回退计数值（backoff counter）的范围。
- Backoff：随机回退过程是指每一个节点在竞争信道时，所经历的随机退避过程。在这一过程开始时，节点首先在竞争窗口中选择一个随机数为基准的随机回退计数值，同时每一个时隙，节点为 **"监听"** 信道是否空闲，若信道空闲，那么进行一次倒数，即计数值减1，若信道忙，则不进行相应倒数。当该随机回退计数值回退到0时，节点可以发送数据。（注：1.该段落中所提到的监听，不仅包含了物理监听，也包含了虚拟监听机制，具体功能后文相应位置进行描述。2.该文中所讨论的一些概念与有线网络中的概念会存在一些区别，我们这里并不加以细节对比，还请见谅）

接着，我们利用时序图描述CSMA/CA的具体工作机制：

![img](https://pic4.zhimg.com/80/16def232e6120952e14b1047592dead3_720w.png)

1. 当STA 1与STA 2相继存在数据，需要在竞争信道进行发送时，其首先需要 **"等待"** DIFS时间，若DIFS时间内，信道保持空闲状态，那么就可以进行backoff过程。
2. 若STA 1与STA 2进入backoff过程时，其首先需要从竞争窗口（Contention window）选择一个随机数，`在802.11协议中，默认的初始竞争窗口为31，即随机回退计数值的范围即是[0,31]。`在上图中，STA 1则是选择了8，而STA 2选择了2。
3. `在backoff过程中，每经过一个slot time，节点会 **"监听"** 一次信道，若信道空闲，则相应的随机回退计数器的值减1。`如上图中，经过3个slot time后，STA 1的随机倒数计数器从8递减至5，而STA 2相应从2递减至0。
4. 当节点的随机倒数计数器倒数至0时，节点竞争获得信道，从而可以发送数据。如上图，STA 2获得信道后，发送PACKET A给AP。在AP接收到数据后，会采用`CRC机制`对数据进行校验，若校验通过，AP会在`SIFS`后，反馈ACK确认帧。
5. 当STA 2成功发送完数据， "**等待**" 了SIFS的时间之后，AP会向节点反馈ACK确认帧。当STA 2成功接收到ACK帧之后，这一次传输完成。
6. 当这一次传输完成后，节点需要再次 **"等待"** DIFS的时间后，重新开始backoff过程。若节点刚刚发送完数据，那么在backoff过程开始时，需要重新从竞争窗口中选择一个随机数进行倒数。若节点没有发送数据，那么直接从上一次的倒数结果继续倒数。如上图中，STA 1没有竞争到信道，那么其在第二次的backoff过程中，直接基于上次的5直接进行倒数至4。这样的设计目的是为了保证网络传输的公平性。

![img](https://pic1.zhimg.com/80/953a4645152850bc7fa9e05e5bacfec4_720w.png)

若在上述的第5步中，AP没有成功接收节点的数据，或者AP对数据进行CRC校验错误，那么其不会反馈相应的ACK给节点。节点在ACK timeout之后，则知道对方没有成功接收数据，该ACK timeout时间在理论分析时，一般与ACK接收时间相等，在具体工程设计中，可能会大一点点。`那么发送错误的节点，需要等待EIFS时间才可以再次接入信道，EIFS>DIFS，这样是为了避免一些较差的节点持续争抢信道资源。`比如图中STA 2即需要在等待EIFS之后，节点首先进行BEB（该机制我们后面详细讨论），然后重新开始backoff过程，而STA 1则直接在DIFS之后进行backoff。

*注1：在这里的描述中，我们所述，在介质忙时，节点通过监听信道，判断介质忙，从而挂起随机回退计数值，这也是很多学术研究中可以看到的常见描述。*

*注2：图中的EIFS起始点应为STA2中SIFS的起始点（图中错误，暂时没有做修改），即EIFS=SIFS+ACK+DIFS时间。*

*有关挂起机制，笔者还存在一些理解。我们知道在节点竞争信道的过程中，也有可能会接收数据。由于802.11协议的特殊性，节点只有在完整解调整个数据包之后，经过CRC校验后，才可以完整判断数据帧是不是自己的，从而进行丢包处理。故挂起机制实际上是一种接收机制，即无论信道中的数据帧是不是发给节点的，该节点都需要对此数据帧进行接收，进而判断是否丢弃该帧。故节点由于处于接收状态，从而无法继续进行backoff回退操作，故这里即是处于挂起的动作。*

*同时在《CWNA教材第三版》中，这里有可能会产生一种误导的理解，即利用Duration字段，即具体采用NAV机制来完成这里挂起随机回退计数值的工作。在该书中，Duration字段用来保留之后SIFS+ACK的时间，而不是用来作为NAV字段保护该数据帧传输过程中挂起其他节点的。换言之，我们前面所提到的ACK timeout的机制，即是采用数据帧中的duration字段来具体设置的。不过除了CWNA书本上的例子外，现实中笔者没有抓到过数据帧MAC头部中Duration存在填充的情况，在这种默认情况下，ACK timeout可能就是SIFS+ACK的标准时间。*

### **BEB机制**

这里BEB机制的全称为Binary Exponential Back off，即二进制指数退避算法。在CSMA/CA的机制中，还是存在发生冲突的可能性，从而为了避免在CSMA/CA机制下的再次冲突，故这里引入了BEB机制。我们举例进行说明：

![img](https://pic1.zhimg.com/80/57df82710936c7c3e11ca293a085fecc_720w.png)

与之前所述CSMA/CA过程类似，在 **"等待"** DIFS后，STA 1与STA 2从各自的竞争窗口CW中选择一个随机数，不过碰巧的是，两者随机到了一样的数值，如图中，STA 1与STA 2都是随机到了3作为随机回退计数值。在经过3个slot time之后，由于两者同时倒数至0，那么意味着两者会同时发送数据，如图中的红色虚线框表示，在AP处由于两者信号互相干扰，从而都无法正确解码，从而CRC校验错误，即发生冲突。在冲突之后，即若AP处CRC校验失败，则不会给任意节点反馈ACK数据包，故两节点在ACK timeout之后（即总共等待EIFS之后，图中EIFS因为DIFS，这里暂未做修改），准备进入下一次竞争。

而在正式进入下一次竞争之前，节点需要对竞争窗口（CW）采用BEB机制，按我们之前所述，在初始竞争时，节点的默认CW范围是[0,31]（假设初始窗口是802.11b机制下，即最大31，在802.11a这种，初始窗口就是15）。而如果在节点数较多的情况下，那么就有可能引发之前我们所述的冲突问题，从而我们需要扩大竞争窗口CW。具体在CSMA/CA中，我们则是采用二进制指数退避的方法对竞争窗口CW进行扩展，即发生一次冲突后，那么CW范围就会从[0,31]变化到[0,63]，如图中，在冲突之后，STA 1重新随机选择50，STA 2重新随机选择32。在802.11中，一共允许回退6次，第7次不倍增窗口，再次尝试重发，若再次失败，则丢包。

参考CWNA教材，有给出具体每一次回退的CW窗口大小，如下：

![img](https://pic4.zhimg.com/80/310a8cb36adfa7a32b5e65ac723e8a1f_720w.png)

### **RTS/CTS模式**

在DCF模式下，我们还需要知道存在两种子模式：Basic模式与RTS/CTS模式。在之前CSMA/CA讨论中，我们所描述的都是Basic模式，这一章我们理解RTS/CTS模式。

为了更好的理解RTS/CTS模式，我们首先要介绍无线网络中著名的隐藏终端问题（hidden terminal problem）。

![img](https://pic4.zhimg.com/80/963bf6b1ac0d5501cf81f0918a113d67_720w.png)

在上图中，还是只有一个AP和两个节点（STA 1与STA 2）。图中蓝色虚线代表STA 1的发送范围，绿色虚线代表STA 2的发送范围。

从图中，我们可以得知，由于两个节点的发送范围无法互相覆盖，从而两者在发送数据时，是无法通过物理监听的方法，探测对方是否有发送数据。从而按照我们之前所述的CSMA/CA机制，STA 1和STA 2一直会误认为信道空闲，从而不断倒数，当计时器到0时，则发送数据，如下图：

![img](https://pic3.zhimg.com/80/ec3c65081032553d2c6bc724a9ff8fa6_720w.png)

在上图中，由于STA 1与STA 2无法互相监听，即STA 2发送数据后，STA 1还继续进行backoff过程，从而继续倒数。当STA 1的随机回退计数值倒数至0时，STA 1也会发送数据。由于STA 1与STA 2的发送存在重叠区域，即也是发生了冲突，AP无法正确接收数据，即不会反馈ACK，最终这一轮传输失败。这一轮失败之后，STA 1与STA 2采用BEB算法重新选择随机数进行回退，但是由于两者没有办法互相监听，所以很容易再次出现同时传输的现象。所以在隐藏终端的情况下，网络性能最差时是无法传递数据包的，换言之，STA 1与STA 2的吞吐量都趋近于0。

为了解决这个问题，故在DCF中，引入了RTS/CTS机制。

- RTS：Request To Send，即请求发送。RTS帧是一个单播帧，没有加密，其duration字段中填充包含后续发送过程中总体所需要时间。
- CTS：Clear To Send，即信道清除帧。节点在收到CTS后，确认信道是空闲的，可以发送。CTS也是一个单播帧，没有加密，其duration字段包含除去RTS以及一个SIFS后，发送过程总体所需要时间。

接着我们采用下图解释RTS/CTS具体的工作方法：



![img](https://pic3.zhimg.com/80/a66c3f592a3bc2f7d73da17a70001d76_720w.png)

在上图中，STA 2已经倒数至0，其首先发送RTS数据帧给AP。若在AP处没有冲突，即AP成功解调出STA 2的RTS，AP会在等待SIFS之后发送CTS帧给STA 2。由于无线信道是一个广播信道，要是帧没有加密的话，那么所有节点都是可以解析其信息的，所以这里AP虽然是发送CTS给STA 2，不过STA 1也可以解析该CTS信息，这也是很多书上写，RTS/CTS都是一个广播过程的原因。

- 当STA 1接收到CTS之后，该CTS不是我所请求所获得的，或者说，该CTS不是对应发给我的CTS。从而STA 1会将CTS数据帧的duration给提出，并设置在自己本地的NAV（Network Allocation Vector）上。若NAV没有倒数到0，那么其会主动悬挂其随机回退计数值，在NAV没有倒数到0之前，其随机回退计数值不再继续倒数。
- 当STA 2接收到CTS后，其发现该其是之前发送RTS的反馈。故节点已知信道空闲，在等待SIFS后，STA 2发送数据。当数据传输完成之后，AP向STA 2反馈ACK，从而最终完成一次传输。

RTS/CTS工作机制对应的时序图如下：

![img](https://pic1.zhimg.com/80/af08da7eb6245fb0ca718462525f2f7c_720w.png)

在上图中，我们可以发现，NAV的部分和我们在CSMA/CA的流程图中的Busy medium是一样的，其区别在于一者是物理载波监听（即之前的Busy medium是由于物理载波监听所引起的），而另者是虚拟载波监听（即NAV是由虚拟载波监听所引起的），在下一节，我们会讨论物理载波监听与虚拟载波监听机制。

在实际的路由器中，RTS/CTS模式不是以开关的形式存在，而是以RTS_threshold的形式存在的。RTS/CTS另外一个思维就是 "**采用小的数据包碰撞，来避免大的数据包碰撞**" ，从而如果数据包太小，那么则不需要采用RTS/CTS机制。设置RTS_threshold的范围一般为2347，其单位是byte，即如果数据包大小如果大于2347 byte，那么才会采用RTS/CTS模式，在现实应用中，可以根据具体的情况，设置一个最适合的值。

*注：在本段中，我们所述RTS/CTS着重解决隐藏终端问题，同时RTS/CTS也是利用小数据包碰撞来避免大数据包碰撞的方法，该方法对于在没有隐藏终端，但是节点数很多的网络中，也时很有效果的。同时，本章节中，我们提到采用RTS/CTS模式来设置NAV，这里需要强调的是，RTS/CTS可以设置NAV，但是NAV不是仅仅只能用RTS/CTS来设置，只要数据帧MAC头部的duration字段有数值，那么就可以设置NAV，该机制在802.11协议中，有非常广泛的应用，比如PCF的Contention Free周期，EDCA中的TXOP机制等。*

### **物理载波监听和虚拟载波监听**

在这一章节，我们讨论物理载波监听和虚拟载波监听机制，两者是在CSMA/CA过程中同时使用的，在《CWNA第一版》一书中，对此有较好的描述：

![img](https://pic2.zhimg.com/80/1f3c731c2ce798d8f5e82c86c494629d_720w.png)

从该图中，我们可以明显看出，物理载波监听和虚拟载波监听是同时执行判断的，其中只要有一个是出于Busy状态，那么就不会触发随机回退计数值减1的过程，换言之，即是挂起了随机回退计数值。从该图中，我们可以明显得知，虚拟载波监听就是对应的NAV机制，而物理载波监听则是对应到了CCA（Clear Channel Assessment）机制。下面我们着重关注物理载波监听的CCA机制：

在CSMA/CA中，CCA由能量检测和载波检测一起完成：

- 能量检测（Energy Detection）：是直接用`物理层接收`的能量来判断是否有信号进行接入，若信号强度大于ED_threshold，则认为信道是忙，若小于ED_threshold，则认为信道是闲。同时该ED_threshold的设置与发送功率有关，比如发送功率大于100mW，那么ED_threhold约为-80dBm，发送功率在50mW至100mW之间，那么ED_threshold应该为-76dBm。不过至于具体的数值，需要查看其具体所对应版本的802.11协议。
- 载波侦听（Carrier Sense）：载波监听的方法指的是用来`识别802.11数据帧的物理层头部（PLCP header）中的preamble部分`。简单的说，802.11中的preamble部分采用特定的序列所构造，该序列对于发送方和接收方都是已知的，其用来做帧同步以及符号同步。在实际监听过程中，节点会不断采样信道信号，用其做自相关或者互相关运算，其中自相关在基于OFDM的802.11技术中常用，比如802.11a，而互相关在基于DSSS技术中常用，比如802.11b。与能量检测类似，相关计算值需要与一个阈值进行判断，若大于，则认为检测到了一个信号，若小于则没有检测到。

协议中规定，两种检测方式同时采用，且只要两者检测方式中，有一种判断信道是busy的话，那么就认为信道是busy的，只有两者都认为信道空闲时，那么再判断虚拟载波监听机制是否为0，以上条件都满足时，那么才可以进行backoff倒数。

### **DIFS，SIFS与Slot time**

最后我们浅谈下DIFS，SIFS与Slot time的具体功能。在前面的叙述中，我们使用 **"等待"** 这一词来描述节点在DIFS与SIFS过程中的动作，同时我们描述slot time内持续监听信道。在实际过程中，DIFS与SIFS不是纯粹的等待动作，而slot time也不是整个周期都是监听信道。我们首先谈谈slot time的构造，由于笔者这一部分没有详细翻阅协议，参考一篇论文《WiFi-Nano: Reclaiming WiFi Efficiency Through 800 ns Slots》，其举例一个9us的slot time的组成如下：

![img](https://pic3.zhimg.com/80/28c4c27c1e56b139ff31f6a33ed60366_720w.png)

即Slot time由电磁波传播时延（Propagation），信道检测CCA时间（Clear Channel Assessment）以及天线的发送/接收切换（Rx/Tx Hardware Turnaround）组成。故这里就明确回答了，在一个slot time内不是整个周期都在监听信道，而只有CCA时间这一部分在监听信道。而最后一个天线发送转换也好理解一些，这里我们在说CCA监听信道的过程中，除了为了之前我们所述的backoff过程，实际上节点也在利用CCA来监听，是不是有给我的数据包。如果该数据包不是给我的，那么CCA监听结果就是忙，然后等一个slot以后继续监听。如果监听该数据包是给我的，那么就直接转换到接收状态，而不是继续进行每一个slot监听的动作了。

同时，这里我们之所以将DIFS，SIFS与Slot time放在一起讨论，是由于DIFS = SIFS + 2*Slot time。SIFS的功能我们可以理解成，包含天线发送接收转换，以及上层处理数据所需要的延迟时间。而DIFS中，由于正巧包含了两倍的Slot time，所以很大程度上，在DIFS内，应该执行了两次信道监听过程，但是这两次的监听过程没有触发backoff。只有监听到连续两次信道空闲后，那么DIFS之后才会进行backoff过程，该设计思想应该是源于P坚持-CSMA的，同时，这个思路也是和我们在讨论物理载波监听和虚拟载波监听中的插图所符合的。类似的，在802.11协议中，其他的部分帧间间隔也是基于slot time和SIFS计算所得，比如PIFS = SIFS + SLOT，EIFS = ACK time + SIFS + DIFS。

笔者重新查了下协议，在协议中SIFS和Slot time的组成被定义如下：

aSIFSTime= aRXRFDelay（射频延迟）＋aRXPLCPDelay（物理层头部接收延迟）＋aMACProcessingDelay（MAC层处理延迟） + aRxTxTurnaroundTime（发送接收天线转换时间）

aSlotTime= aCCATime（CCA时间）＋aRxTxTurnaroundTime（发送接收天线转换时间）＋aAirPropagationTime（传播延迟）＋aMACProcessingDelay（MAC层处理延迟）

故基本是和我们之前的描述一样的，细节上还增加了几项，故这里标注一下。

# ath9k无线驱动

## 内核初始化流程

```c
asmlinkage void _init start_kernel(void)
static void noinline _init_refok rest_init(void)
static int _init kernel_init(void* unused)
static void _init do_basic_setup(void)
static void _init do_initcalls(void)
```

### do_initcalls

```c
static void _init do_initcalls(void){
	initcall_t *call;
	for(call=_initcall_start;call<_initcall_end;call++){
        do_one_initcall(*call);
        
        flush_scheduled_work();
    }
}
```

在这个函数中，会循环遍历内核中注册过的模块去依次初始化。

不管是驱动的模块还是协议栈的模块最开始都注册到initcall中，然后等系统运行到do_initcalls()函数时便一一遍历进行初始化。

```c
#define module_init(x) _initcall(x);
```

## 无线驱动

### ath9k驱动初始化

```c
module_init(ath9k_init);
```

把ath9k_init注册进initcalls()函数中

```c
static int __init ath9k_init(void)
{
	int error;

	/* Register rate control algorithm */
	error = ath_rate_control_register();
	if (error != 0) {
		pr_err("Unable to register rate control algorithm: %d\n",
		       error);
		goto err_out;
	}

	error = ath_pci_init();
	if (error < 0) {
		pr_err("No PCI devices found, driver not installed\n");
		error = -ENODEV;
		goto err_rate_unregister;
	}

	error = ath_ahb_init();
	if (error < 0) {
		error = -ENODEV;
		goto err_pci_exit;
	}

	return 0;

 err_pci_exit:
	ath_pci_exit();

 err_rate_unregister:
	ath_rate_control_unregister();
 err_out:
	return error;
}
```

在ath9k_init函数中，主要是对驱动进行注册

